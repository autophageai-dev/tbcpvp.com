{% comment %}
TBC Arena Strategy Builder v1.8 - CC Chain Fixed
Visual CC chain builder with proper PvP durations and visual timeline output
{% endcomment %}

<style>
:root {
  --bg-primary: #0a0a0a;
  --bg-secondary: #1a1a1a;
  --bg-card: rgba(255, 255, 255, 0.05);
  --border-color: rgba(255, 255, 255, 0.1);
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --text-muted: #666666;
  --accent-green: #00ff41;
  --accent-blue: #2563eb;
  --accent-red: #dc2626;
  --accent-gray: #4a4a4a;
  --cc-stun: #ff4444;
  --cc-fear: #8844aa;
  --cc-poly: #4488ff;
  --cc-root: #44aa44;
  --cc-silence: #ff8844;
}

html { scroll-behavior: smooth; }
* { box-sizing: border-box; }

@keyframes fadeIn { to { opacity: 1; } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
@keyframes celebrate { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 65, 0.3); } 50% { box-shadow: 0 0 20px rgba(0, 255, 65, 0.6); } }
@keyframes scaleIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes checkmark { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
@keyframes spin { to { transform: rotate(360deg); } }

.strategy-builder-v1 {
  background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  padding: 30px 15px 80px;
  min-height: 100vh;
}

.sb-container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

.progress-indicator {
  position: sticky; top: 0; z-index: 50;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(10, 10, 10, 0.95) 100%);
  border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 6px;
  padding: 12px 20px; margin-bottom: 20px;
  display: flex; align-items: center; justify-content: space-between;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 255, 65, 0.15);
}

.progress-text { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; }
.progress-bar-container { flex: 1; height: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 4px; margin: 0 15px; overflow: hidden; }
.progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent-green), #00cc33); border-radius: 4px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(0, 255, 65, 0.5); }
.progress-count { font-size: 0.85rem; color: var(--accent-green); font-weight: 700; }

.welcome-tooltip, .publish-modal {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  border: 2px solid var(--accent-green); border-radius: 12px;
  padding: 40px 45px; max-width: 650px; width: 90%; z-index: 10001;
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.95), 0 0 100px rgba(0, 255, 65, 0.3);
  animation: scaleIn 0.5s ease-out; display: none;
}
.welcome-tooltip.active, .publish-modal.active { display: block; }

.welcome-overlay, .modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
  z-index: 10000; display: none; animation: fadeIn 0.4s ease-out;
}
.welcome-overlay.active, .modal-overlay.active { display: block; }

.welcome-title { font-size: 1.8rem; color: var(--text-primary); font-weight: 800; margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
.welcome-subtitle { font-size: 1rem; color: var(--accent-green); font-weight: 700; margin-bottom: 25px; text-align: center; line-height: 1.5; }
.welcome-steps { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 25px; }
.welcome-step { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 3px solid var(--accent-green); }
.welcome-step:last-child { margin-bottom: 0; }
.welcome-step-number { background: var(--accent-green); color: #000; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.9rem; flex-shrink: 0; }
.welcome-step-content { flex: 1; }
.welcome-step-title { color: var(--text-primary); font-size: 0.95rem; font-weight: 700; margin-bottom: 4px; }
.welcome-step-desc { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.4; }
.welcome-actions { display: flex; gap: 12px; }
.welcome-btn { flex: 1; background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; border: none; padding: 14px; border-radius: 6px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
.welcome-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0, 255, 65, 0.5); }

.undo-toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(100px); background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid var(--accent-green); border-radius: 6px; padding: 12px 20px; display: flex; align-items: center; gap: 15px; z-index: 9999; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 255, 65, 0.3); opacity: 0; transition: all 0.3s ease-out; }
.undo-toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
.undo-toast-text { color: var(--text-primary); font-size: 0.85rem; font-weight: 600; }
.undo-btn { background: var(--accent-green); color: #000; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; transition: all 0.3s; }
.undo-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 255, 65, 0.5); }

.publish-modal { padding: 0; max-width: 550px; }
.publish-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px; border-bottom: 1px solid rgba(0, 255, 65, 0.2); }
.publish-modal-title { font-size: 1.4rem; color: var(--text-primary); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
.publish-modal-close { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
.publish-modal-close:hover { border-color: var(--accent-red); color: var(--accent-red); transform: rotate(90deg); }
.publish-modal-body { padding: 30px; }
.publish-description { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 25px; text-align: center; }
.publish-options { display: flex; flex-direction: column; gap: 15px; }
.publish-option-btn { background: rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px; text-align: left; }
.publish-option-btn:hover { border-color: var(--accent-green); background: rgba(0, 255, 65, 0.05); transform: translateX(5px); box-shadow: 0 0 25px rgba(0, 255, 65, 0.2); }
.publish-option-icon { font-size: 2.5rem; flex-shrink: 0; }
.publish-option-content { flex: 1; }
.publish-option-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 5px; }
.publish-option-desc { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; }

.published-view-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 15000; display: none; }
.published-view-overlay.active { display: block; }
.published-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 15001; overflow-y: auto; display: none; background: linear-gradient(180deg, #050505 0%, #0d0d0d 50%, #0a0a0a 100%); }
.published-view.active { display: block; }
.published-container { max-width: 900px; margin: 0 auto; padding: 30px 30px 100px; }
.published-close-btn { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; margin-bottom: 20px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.published-close-btn:hover { border-color: var(--accent-green); color: var(--accent-green); transform: translateX(-4px); }
.published-content { background: transparent; border: none; padding: 0; margin-bottom: 30px; }
.published-actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
.published-action-btn { background: rgba(0, 0, 0, 0.8); border: 2px solid var(--accent-green); color: var(--accent-green); padding: 14px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 700; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
.published-action-btn:hover { background: var(--accent-green); color: #000; transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0, 255, 65, 0.4); }

/* Published Article - Hero Section */
.pub-hero { text-align: center; padding: 50px 30px 40px; margin-bottom: 30px; background: linear-gradient(135deg, rgba(0,255,65,0.03) 0%, transparent 50%, rgba(0,255,65,0.02) 100%); border: 1px solid rgba(0,255,65,0.15); border-radius: 16px; position: relative; }
.pub-hero::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 200px; height: 3px; background: linear-gradient(90deg, transparent, var(--accent-green), transparent); }
.pub-title { font-size: 2.2rem; font-weight: 900; color: #fff; margin-bottom: 20px; line-height: 1.3; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 30px rgba(0,255,65,0.3); }
.pub-meta { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; }
.pub-meta-item { font-size: 0.85rem; color: #888; font-weight: 600; }

/* Published Article - Matchup Card */
.pub-matchup { background: linear-gradient(135deg, rgba(0,0,0,0.6) 0%, rgba(20,20,20,0.8) 100%); border: 1px solid rgba(0,255,65,0.2); border-radius: 12px; padding: 30px; margin-bottom: 35px; }
.pub-matchup-inner { display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; margin-bottom: 25px; }
.pub-team { text-align: center; }
.pub-team-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; margin-bottom: 15px; }
.pub-team-comp { display: flex; flex-direction: column; gap: 8px; }
.comp-player { display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; color: #ddd; }
.comp-icon { width: 24px; height: 24px; border-radius: 4px; }
.pub-vs { font-size: 2.5rem; font-weight: 900; color: var(--accent-green); text-shadow: 0 0 30px rgba(0,255,65,0.6); }
.pub-targets { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
.target-badge { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; }
.target-badge.kill { background: rgba(220,38,38,0.2); border: 1px solid rgba(220,38,38,0.4); color: #ff6b6b; }
.target-badge.cc { background: rgba(100,100,100,0.2); border: 1px solid rgba(150,150,150,0.3); color: #aaa; }
.target-badge .target-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
.target-badge .target-icon { width: 22px; height: 22px; border-radius: 4px; }

/* Published Article - Sections */
.pub-section { margin-bottom: 40px; background: linear-gradient(135deg, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0.3) 100%); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow: hidden; }
.pub-section-header { display: flex; align-items: center; gap: 15px; padding: 20px 25px; background: linear-gradient(135deg, rgba(0,255,65,0.08) 0%, rgba(0,255,65,0.02) 100%); border-bottom: 1px solid rgba(0,255,65,0.15); }
.pub-section-icon { font-size: 1.8rem; }
.pub-section-titles { flex: 1; }
.pub-section-title { font-size: 1.3rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
.pub-section-desc { font-size: 0.75rem; color: #666; margin-top: 3px; }
.pub-section-content { padding: 25px; }

/* Published Article - Steps */
.pub-step { display: flex; gap: 20px; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.pub-step:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.pub-step-num { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.95rem; flex-shrink: 0; box-shadow: 0 0 15px rgba(0,255,65,0.4); }
.pub-step-body { flex: 1; }

/* Published Article - Player Actions */
.pub-player-action { margin-bottom: 20px; }
.pub-player-action:last-child { margin-bottom: 0; }
.pub-player-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,255,65,0.1); }
.pub-player-icon { width: 32px; height: 32px; border-radius: 6px; border: 2px solid rgba(0,255,65,0.3); }
.pub-player-name { font-size: 0.85rem; font-weight: 800; color: var(--accent-green); text-transform: uppercase; letter-spacing: 1px; }
.pub-player-text { color: #ccc; font-size: 0.95rem; line-height: 1.8; }
.pub-player-text p { margin-bottom: 12px; }
.pub-player-text p:last-child { margin-bottom: 0; }
.pub-player-text strong { color: #fff; }
.pub-player-text ul, .pub-player-text ol { margin-left: 20px; margin-bottom: 12px; }
.pub-player-text li { margin-bottom: 6px; }

/* Legacy guide classes for backwards compat */
.guide-header { text-align: center; margin-bottom: 50px; padding-bottom: 30px; border-bottom: 2px solid rgba(0, 255, 65, 0.2); }
.guide-title { font-size: 2.5rem; font-weight: 900; color: var(--text-primary); margin-bottom: 15px; line-height: 1.2; text-transform: uppercase; letter-spacing: 1px; }
.guide-meta { font-size: 0.95rem; color: var(--text-secondary); display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
.guide-meta-item { display: flex; align-items: center; gap: 6px; }
.guide-matchup { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 65, 0.2); border-radius: 10px; padding: 30px; margin-bottom: 40px; }
.matchup-title { font-size: 1.2rem; font-weight: 800; color: var(--accent-green); text-transform: uppercase; text-align: center; margin-bottom: 25px; letter-spacing: 1px; }
.matchup-teams { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 25px; }
.matchup-team { text-align: center; }
.matchup-team-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700; }
.matchup-team-comp { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; line-height: 1.6; }
.matchup-vs { font-size: 2rem; font-weight: 900; color: var(--accent-green); text-shadow: 0 0 20px rgba(0, 255, 65, 0.5); }
.matchup-targets { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.05); }
.target-item { display: flex; align-items: center; gap: 8px; background: rgba(0, 0, 0, 0.3); padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1); }
.target-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }
.target-value { font-size: 0.9rem; color: var(--accent-green); font-weight: 700; }
.guide-section { margin-bottom: 50px; }
.guide-section-header { font-size: 1.8rem; font-weight: 900; color: var(--text-primary); margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 12px; padding-bottom: 12px; border-bottom: 2px solid rgba(0, 255, 65, 0.3); }
.guide-section-icon { font-size: 2rem; }
.guide-step { background: rgba(0, 0, 0, 0.3); border-left: 4px solid var(--accent-green); border-radius: 6px; padding: 25px 30px; margin-bottom: 20px; }
.guide-step-number { display: inline-block; background: var(--accent-green); color: #000; width: 32px; height: 32px; border-radius: 50%; text-align: center; line-height: 32px; font-weight: 900; font-size: 0.9rem; margin-bottom: 15px; }
.guide-player-action { margin-bottom: 20px; }
.guide-player-action:last-child { margin-bottom: 0; }
.guide-player-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.guide-player-icon { width: 28px; height: 28px; border-radius: 4px; filter: drop-shadow(0 0 6px rgba(0, 255, 65, 0.4)); }
.guide-player-name { font-size: 0.9rem; font-weight: 700; color: var(--accent-green); text-transform: uppercase; }
.guide-player-text { color: var(--text-primary); font-size: 1rem; line-height: 1.8; padding-left: 38px; }
.guide-player-text p { margin-bottom: 10px; }
.guide-player-text ul, .guide-player-text ol { margin-left: 20px; margin-bottom: 10px; }

@media (max-width: 768px) {
  .pub-title { font-size: 1.6rem; }
  .pub-matchup-inner { grid-template-columns: 1fr; gap: 20px; }
  .pub-vs { transform: rotate(90deg); font-size: 1.8rem; }
  .pub-section-header { padding: 15px 20px; }
  .pub-section-content { padding: 20px; }
  .pub-step { flex-direction: column; gap: 15px; }
  .pub-step-num { width: 30px; height: 30px; font-size: 0.85rem; }
}

.sb-header {
  background-image: linear-gradient(135deg, rgba(0, 0, 0, 0.5) 0%, rgba(10, 10, 10, 0.6) 100%), url('https://cdn.shopify.com/s/files/1/0964/2609/8968/files/nagrand.webp?v=1766796760');
  background-size: cover; background-position: center; background-repeat: no-repeat;
  border: 1px solid var(--accent-green); border-radius: 8px; padding: 35px 20px; margin-bottom: 25px;
  text-align: center; position: relative; overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 255, 65, 0.2);
}
.sb-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--accent-green), transparent); opacity: 0.5; }
.sb-logo { max-width: 200px; height: auto; margin: 0 auto 15px; display: block; filter: drop-shadow(0 0 15px rgba(0, 255, 65, 0.4)); position: relative; z-index: 1; }
.sb-title { font-size: 1.5rem; font-weight: 800; color: var(--accent-green); margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 15px rgba(0, 255, 65, 0.6), 0 2px 8px rgba(0, 0, 0, 0.9); position: relative; z-index: 1; }

.strategy-info { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.info-field { margin-bottom: 0; }
.info-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 5px; }
.info-input { width: 100%; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); color: var(--text-primary); padding: 9px 11px; border-radius: 5px; font-size: 0.9rem; transition: all 0.3s; }
.info-input:focus { outline: none; border-color: var(--accent-green); box-shadow: 0 0 0 2px rgba(0, 255, 65, 0.15); background: rgba(0, 0, 0, 0.7); }
.info-input::placeholder { color: var(--text-muted); }

.bracket-section { text-align: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); }
.bracket-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 12px; }
.bracket-selector { display: flex; gap: 10px; justify-content: center; }
.bracket-btn { background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-color); color: var(--text-secondary); padding: 12px 32px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 0.95rem; }
.bracket-btn:hover { border-color: var(--accent-green); color: var(--text-primary); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3); }
.bracket-btn.active { border-color: var(--accent-green); background: rgba(0, 255, 65, 0.15); color: var(--accent-green); box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); }

.team-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 25px; }
.team-builder { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid var(--border-color); border-radius: 8px; padding: 14px; transition: all 0.3s; }
.team-builder:hover { border-color: rgba(0, 255, 65, 0.3); box-shadow: 0 0 25px rgba(0, 255, 65, 0.1); }
.team-header { font-size: 0.85rem; color: var(--accent-green); margin-bottom: 10px; font-weight: 700; text-align: center; text-transform: uppercase; }
.faction-selector { display: flex; gap: 8px; margin-bottom: 12px; justify-content: center; }
.faction-btn { background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-color); border-radius: 5px; padding: 6px 10px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; font-size: 0.75rem; font-weight: 600; }
.faction-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
.faction-btn.alliance.active { border-color: var(--accent-blue); background: rgba(37, 99, 235, 0.2); box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
.faction-btn.horde.active { border-color: var(--accent-red); background: rgba(220, 38, 38, 0.2); box-shadow: 0 0 15px rgba(220, 38, 38, 0.4); }
.faction-btn.both.active { border-color: var(--accent-green); background: rgba(0, 255, 65, 0.2); box-shadow: 0 0 15px rgba(0, 255, 65, 0.4); }
.faction-icon { width: 20px; height: 20px; border-radius: 3px; }
.faction-name { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.faction-btn.alliance .faction-name { color: var(--accent-blue); }
.faction-btn.horde .faction-name { color: var(--accent-red); }
.faction-btn.both .faction-name { color: var(--accent-green); }
.player-slots { display: flex; flex-direction: column; gap: 10px; }
.player-slot { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; min-height: 80px; display: flex; flex-direction: column; gap: 8px; transition: all 0.3s; }
.player-slot:hover { border-color: rgba(0, 255, 65, 0.3); }
.selection-step { opacity: 0; animation: fadeIn 0.4s forwards; }
.step-label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 6px; }
.selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.selection-option { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); padding: 6px 4px; border-radius: 4px; cursor: pointer; transition: all 0.3s; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 3px; }
.selection-option:hover { border-color: var(--accent-green); transform: scale(1.08); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
.selection-option.active { border-color: var(--accent-green); background: rgba(255, 255, 255, 0.08); }
.option-icon { width: 32px; height: 32px; opacity: 0.5; filter: grayscale(1); transition: all 0.3s; border-radius: 3px; }
.selection-option:hover .option-icon, .selection-option.active .option-icon { opacity: 1; filter: grayscale(0) drop-shadow(0 0 8px rgba(255, 255, 255, 0.3)); }
.option-icon.race { border-radius: 50%; }
.option-text { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; line-height: 1.2; }
.selection-option.active .option-text { color: var(--text-primary); }
.selected-summary { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--accent-green); border-radius: 5px; padding: 8px 10px; display: flex; align-items: center; gap: 8px; justify-content: space-between; }
.summary-content { display: flex; align-items: center; gap: 8px; flex: 1; }
.summary-icons { display: flex; gap: 4px; }
.summary-icon { width: 24px; height: 24px; border-radius: 3px; filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3)); }
.summary-text { font-size: 0.8rem; color: var(--text-primary); font-weight: 600; }
.change-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem; transition: all 0.3s; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
.change-btn:hover { border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 10px rgba(0, 255, 65, 0.3); }

.kill-target-section { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 18px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); }
.kill-target-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 15px; text-align: center; }
.target-assignment-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: start; }
.enemy-pool { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; min-height: 200px; display: flex; flex-direction: column; }
.pool-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; text-align: center; }
.enemy-icons-pool { display: flex; flex-direction: column; gap: 8px; flex: 1; }
.enemy-icon-item { background: rgba(0, 0, 0, 0.6); border: 2px solid var(--border-color); border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 10px; cursor: grab; transition: all 0.3s; }
.enemy-icon-item:hover { border-color: var(--accent-green); transform: translateX(4px); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
.enemy-icon-item:active { cursor: grabbing; }
.enemy-icon-item.dragging { opacity: 0.5; }
.enemy-class-icon { width: 36px; height: 36px; border-radius: 4px; filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.2)); }
.enemy-class-name { font-size: 0.85rem; color: var(--text-primary); font-weight: 700; flex: 1; }
.assignment-zone { background: rgba(0, 0, 0, 0.4); border: 2px dashed var(--border-color); border-radius: 6px; padding: 12px; min-height: 200px; transition: all 0.3s; display: flex; flex-direction: column; }
.assignment-zone.kill { border-color: rgba(220, 38, 38, 0.3); }
.assignment-zone.cc { border-color: rgba(74, 74, 74, 0.3); }
.assignment-zone.drop-active { border-style: solid; background: rgba(0, 255, 65, 0.1); border-color: var(--accent-green); box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); }
.zone-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; margin-bottom: 12px; text-align: center; padding: 6px; border-radius: 4px; }
.zone-label.kill { color: var(--accent-red); background: rgba(220, 38, 38, 0.15); }
.zone-label.cc { color: var(--text-secondary); background: rgba(74, 74, 74, 0.15); }
.assigned-targets { display: flex; flex-direction: column; gap: 8px; flex: 1; }
.assigned-target { background: rgba(0, 0, 0, 0.6); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 10px; position: relative; animation: slideIn 0.3s ease-out; }
.assigned-target.kill-target { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(220, 38, 38, 0.3); }
.assigned-target.cc-target { border-color: rgba(255, 255, 255, 0.3); }
.remove-assignment { position: absolute; top: -6px; right: -6px; background: var(--accent-red); color: #fff; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 0.8rem; line-height: 1; display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); transition: all 0.3s; }
.remove-assignment:hover { transform: scale(1.1); }
.empty-zone-text { color: var(--text-muted); font-size: 0.7rem; text-align: center; padding: 20px; font-style: italic; }

.map-section { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 18px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); }
.map-section-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 12px; text-align: center; }
.map-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
.map-option { background: rgba(0, 0, 0, 0.6); border: 2px solid var(--border-color); border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.3s; text-align: center; }
.map-option:hover { border-color: var(--accent-green); transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 255, 65, 0.4); }
.map-option.active { border-color: var(--accent-green); background: rgba(255, 255, 255, 0.08); box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); }
.map-image { width: 100%; height: 80px; object-fit: cover; display: block; opacity: 0.7; transition: all 0.3s; }
.map-option:hover .map-image, .map-option.active .map-image { opacity: 1; filter: brightness(1.1); }
.map-name { padding: 8px 6px; font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; background: rgba(0, 0, 0, 0.8); transition: all 0.3s; }
.map-option.active .map-name { color: var(--text-primary); background: rgba(0, 255, 65, 0.15); }

.strategy-sections { margin-top: 25px; }
.strategy-section { background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; overflow: hidden; transition: all 0.3s; position: relative; }
.strategy-section.empty { animation: pulse 3s ease-in-out infinite; }
.strategy-section.completed { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); }
.strategy-section.completed .section-icon::after { content: '✓'; position: absolute; right: -25px; color: var(--accent-green); font-size: 1.2rem; font-weight: 900; animation: celebrate 0.5s ease-out; }
.strategy-section:hover { border-color: rgba(0, 255, 65, 0.3); box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); transform: translateY(-2px); }
.section-header { background: rgba(0, 0, 0, 0.5); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
.section-header:hover { background: rgba(0, 255, 65, 0.1); }
.section-title { font-size: 1rem; color: var(--text-primary); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
.section-icon { font-size: 1.1rem; color: var(--text-primary); transition: transform 0.3s; position: relative; }
.section-header.collapsed .section-icon { transform: rotate(-90deg); }
.section-content { padding: 12px; display: none; animation: slideDown 0.3s ease-out; }
.section-content.active { display: block; }
.steps-container { display: flex; flex-direction: column; gap: 10px; min-height: 60px; }
.steps-container:empty::after { content: '✨ Click "Add Step" below to start building your strategy'; display: block; text-align: center; color: var(--text-muted); font-size: 0.8rem; font-style: italic; padding: 20px; opacity: 0.8; background: rgba(0, 255, 65, 0.03); border: 1px dashed rgba(0, 255, 65, 0.2); border-radius: 6px; }
.step-item { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; cursor: move; transition: all 0.3s; }
.step-item:hover { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); }
.step-header { display: flex; gap: 7px; align-items: center; margin-bottom: 8px; }
.step-number { background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.85rem; flex-shrink: 0; box-shadow: 0 0 15px rgba(0, 255, 65, 0.6); }
.step-control-btn { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); color: var(--text-secondary); width: 22px; height: 22px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; flex-shrink: 0; transition: all 0.3s; }
.step-control-btn:hover { border-color: var(--accent-green); color: var(--accent-green); }
.step-control-btn.delete:hover { border-color: var(--accent-red); color: var(--accent-red); box-shadow: 0 0 10px rgba(220, 38, 38, 0.3); }
.step-title { font-size: 0.85rem; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px; flex: 1; }
.step-save-btn { background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; transition: all 0.3s; box-shadow: 0 0 10px rgba(0, 255, 65, 0.4); animation: pulse 2s ease-in-out infinite; }
.step-save-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 255, 65, 0.6); }
.step-save-btn.saved { background: rgba(0, 0, 0, 0.6); color: var(--accent-green); border: 1px solid var(--accent-green); animation: none; pointer-events: none; }
.step-save-btn.saved .save-icon { animation: checkmark 0.5s ease-out; }
.step-edit-btn { background: rgba(0, 0, 0, 0.6); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; transition: all 0.3s; }
.step-edit-btn:hover { border-color: var(--accent-green); color: var(--accent-green); background: rgba(0, 255, 65, 0.05); }
.step-content-wrapper { position: relative; }
.step-readonly-view { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; padding: 12px; margin-bottom: 12px; }
.readonly-player-content { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.readonly-player-content:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.readonly-player-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.readonly-player-icon { width: 24px; height: 24px; border-radius: 3px; filter: drop-shadow(0 0 4px rgba(0, 255, 65, 0.3)); }
.readonly-player-name { font-size: 0.75rem; font-weight: 700; color: var(--accent-green); text-transform: uppercase; }
.readonly-player-text { color: var(--text-primary); font-size: 0.9rem; line-height: 1.6; padding-left: 32px; }
.step-actions { display: flex; align-items: center; gap: 0; margin-top: 6px; }
.player-step-section { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 6px; padding: 10px; margin-bottom: 6px; transition: all 0.3s; }
.player-step-section:hover { border-color: rgba(0, 255, 65, 0.3); background: rgba(0, 0, 0, 0.4); }
.player-step-section:last-of-type { margin-bottom: 0; }
.player-step-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(0, 255, 65, 0.2); }
.player-step-icon { width: 32px; height: 32px; border-radius: 4px; filter: drop-shadow(0 0 6px rgba(0, 255, 65, 0.4)); }
.player-step-name { font-size: 0.85rem; font-weight: 700; color: var(--accent-green); text-transform: uppercase; letter-spacing: 0.5px; }
.add-cc-chain-btn { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-muted); padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: 600; margin-top: 6px; transition: all 0.3s; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; position: relative; display: inline-block; }
.add-cc-chain-btn:hover { border-color: var(--accent-green); color: var(--accent-green); background: rgba(0, 255, 65, 0.05); box-shadow: 0 0 10px rgba(0, 255, 65, 0.2); }

.ql-toolbar { background: rgba(0, 0, 0, 0.5) !important; border: 1px solid var(--border-color) !important; border-radius: 5px 5px 0 0 !important; }
.ql-container { background: rgba(0, 0, 0, 0.3) !important; border: 1px solid var(--border-color) !important; border-top: none !important; border-radius: 0 0 5px 5px !important; font-family: inherit !important; transition: all 0.3s; }
.ql-container.ql-focused { background: rgba(255, 255, 255, 0.05) !important; border-color: var(--accent-green) !important; box-shadow: 0 0 20px rgba(0, 255, 65, 0.3), 0 0 0 2px rgba(0, 255, 65, 0.1); transform: translateY(-2px); }
.ql-editor { min-height: 180px; color: #ffffff !important; font-size: 0.9rem; line-height: 1.6; }
.ql-editor strong, .ql-editor p { color: #ffffff !important; }
.ql-editor.ql-blank::before { color: #999999 !important; font-style: normal !important; content: '✨ Click here to start typing your strategy. Use the "⚡ Add CC Chain" button above to insert visual timelines.' !important; opacity: 0.8; }
.ql-editor:focus { caret-color: var(--accent-green); }
.ql-editor.ql-blank:focus::before { content: '' !important; }
.ql-stroke { stroke: var(--text-secondary) !important; }
.ql-fill { fill: var(--text-secondary) !important; }
.ql-picker-label { color: var(--text-secondary) !important; }
.ql-toolbar button:hover .ql-stroke, .ql-toolbar button.ql-active .ql-stroke { stroke: var(--accent-green) !important; }
.ql-toolbar button:hover .ql-fill, .ql-toolbar button.ql-active .ql-fill { fill: var(--accent-green) !important; }

.image-upload-area { margin-top: 6px; border: 1px dashed rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 4px 8px; cursor: pointer; transition: all 0.3s; background: transparent; display: inline-flex; align-items: center; gap: 6px; margin-left: 8px; }
.image-upload-area:hover { border-color: var(--accent-green); background: rgba(0, 255, 65, 0.05); box-shadow: 0 0 10px rgba(0, 255, 65, 0.2); }
.upload-icon { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0; }
.upload-text { color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
.uploaded-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px; margin-top: 8px; }
.uploaded-image { position: relative; border-radius: 5px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s; }
.uploaded-image:hover { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
.uploaded-image img { width: 100%; height: 80px; object-fit: cover; display: block; }
.remove-image-btn { position: absolute; top: 3px; right: 3px; background: var(--accent-red); color: #fff; border: none; width: 18px; height: 18px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.9rem; line-height: 1; box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
.add-step-btn { background: transparent; border: 1px dashed var(--border-color); color: var(--text-secondary); padding: 8px; border-radius: 5px; cursor: pointer; transition: all 0.3s; text-align: center; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 10px; width: 100%; }
.add-step-btn:hover { border-color: var(--accent-green); color: var(--accent-green); background: rgba(0, 255, 65, 0.05); box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); }

.cc-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px); }
.cc-modal-overlay.active { display: flex; }
.cc-modal { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 2px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 25px; max-width: 95vw; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); }
.cc-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
.cc-modal-title { font-size: 1.2rem; color: var(--text-primary); font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }
.cc-modal-close { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
.cc-modal-close:hover { border-color: var(--accent-red); color: var(--accent-red); box-shadow: 0 0 15px rgba(220, 38, 38, 0.3); }
.cc-modal-content { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
.ability-library { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; max-height: 500px; overflow-y: auto; }
.ability-library-header { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; }
.ability-search { width: 100%; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); color: var(--text-primary); padding: 6px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; }
.ability-search:focus { outline: none; border-color: var(--accent-green); }
.ability-class-group { margin-bottom: 12px; }
.ability-class-name { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 6px; padding: 4px 6px; background: rgba(0, 0, 0, 0.5); border-radius: 3px; }
.ability-list { display: flex; flex-direction: column; gap: 4px; }
.ability-item { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px; cursor: grab; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
.ability-item:hover { border-color: var(--accent-green); transform: translateX(4px); box-shadow: 0 0 10px rgba(0, 255, 65, 0.2); }
.ability-item:active { cursor: grabbing; }
.ability-item.stun { border-left: 3px solid var(--cc-stun); }
.ability-item.fear { border-left: 3px solid var(--cc-fear); }
.ability-item.poly { border-left: 3px solid var(--cc-poly); }
.ability-item.root { border-left: 3px solid var(--cc-root); }
.ability-item.silence { border-left: 3px solid var(--cc-silence); }
.ability-icon { width: 28px; height: 28px; border-radius: 3px; border: 1px solid rgba(0, 0, 0, 0.5); filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.5)); }
.ability-name { font-size: 0.7rem; color: var(--text-primary); font-weight: 600; flex: 1; }
.ability-duration { font-size: 0.65rem; color: var(--text-muted); }
.timeline-container { background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; overflow-x: auto; }
.timeline-header { display: flex; gap: 8px; margin-bottom: 10px; padding-left: 100px; }
.timeline-second { min-width: 50px; text-align: center; font-size: 0.7rem; color: var(--text-muted); font-weight: 600; }
.timeline-rows { display: flex; flex-direction: column; gap: 8px; }
.timeline-row { display: flex; gap: 8px; align-items: center; }
.timeline-player-label { width: 90px; font-size: 0.75rem; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 4px; }
.timeline-player-icon { width: 20px; height: 20px; border-radius: 3px; }
.timeline-grid { display: flex; gap: 8px; flex: 1; }
.timeline-cell { min-width: 50px; height: 40px; background: rgba(0, 0, 0, 0.6); border: 1px dashed var(--border-color); border-radius: 4px; position: relative; transition: all 0.3s; }
.timeline-cell.drop-target { border-color: var(--accent-green); background: rgba(0, 255, 65, 0.1); box-shadow: 0 0 10px rgba(0, 255, 65, 0.3); }
.placed-ability { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: rgba(0, 0, 0, 0.9); border-radius: 3px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
.placed-ability:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 0 15px rgba(0, 255, 65, 0.5); }
.placed-ability.stun { border: 2px solid var(--cc-stun); box-shadow: 0 0 8px var(--cc-stun); }
.placed-ability.fear { border: 2px solid var(--cc-fear); box-shadow: 0 0 8px var(--cc-fear); }
.placed-ability.poly { border: 2px solid var(--cc-poly); box-shadow: 0 0 8px var(--cc-poly); }
.placed-ability.root { border: 2px solid var(--cc-root); box-shadow: 0 0 8px var(--cc-root); }
.placed-ability.silence { border: 2px solid var(--cc-silence); box-shadow: 0 0 8px var(--cc-silence); }
.placed-ability-icon { width: 24px; height: 24px; border-radius: 3px; }
.placed-ability-target { font-size: 0.55rem; color: var(--text-muted); margin-top: 2px; }
.remove-ability { position: absolute; top: -6px; right: -6px; background: var(--accent-red); color: #fff; border: none; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; font-size: 0.7rem; line-height: 1; display: none; align-items: center; justify-content: center; font-weight: 900; }
.placed-ability:hover .remove-ability { display: flex; }
.cc-modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }
.cc-modal-btn { padding: 8px 18px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; }
.cc-modal-btn.primary { background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; border: none; box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
.cc-modal-btn.primary:hover { box-shadow: 0 4px 20px rgba(0, 255, 65, 0.5); transform: translateY(-2px); }
.cc-modal-btn.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
.cc-modal-btn.secondary:hover { border-color: var(--accent-green); color: var(--accent-green); }

.target-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 10000; }
.target-modal-overlay.active { display: flex; }
.target-modal { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 2px solid var(--accent-red); border-radius: 12px; padding: 25px; box-shadow: 0 0 50px rgba(220, 38, 38, 0.5); max-width: 500px; }
.target-modal-title { font-size: 1rem; color: var(--accent-red); font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 15px; text-align: center; }
.target-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px; }
.target-option { background: rgba(0, 0, 0, 0.6); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px 10px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.target-option:hover { border-color: var(--accent-red); background: rgba(220, 38, 38, 0.1); transform: scale(1.05); box-shadow: 0 0 20px rgba(220, 38, 38, 0.3); }
.target-option-icon { width: 48px; height: 48px; border-radius: 6px; filter: drop-shadow(0 0 8px rgba(220, 38, 38, 0.5)); }
.target-option-name { font-size: 0.85rem; color: var(--text-primary); font-weight: 700; }
.target-modal-cancel { width: 100%; padding: 8px; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; transition: all 0.3s; }
.target-modal-cancel:hover { border-color: var(--accent-green); color: var(--accent-green); }

.export-toolbar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 999999 !important; background: linear-gradient(180deg, rgba(10, 10, 10, 0.95) 0%, rgba(10, 10, 10, 0.98) 100%); border-top: 1px solid rgba(255, 255, 255, 0.15); padding: 10px; display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap; backdrop-filter: blur(10px); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.8); pointer-events: auto !important; }
.export-btn { background: rgba(0, 0, 0, 0.9); color: var(--text-primary); border: 1px solid var(--border-color); padding: 16px 32px; font-size: 1rem; font-weight: 700; border-radius: 5px; cursor: pointer !important; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); pointer-events: auto !important; position: relative; z-index: 1; min-width: 160px; display: inline-block; text-align: center; }
.export-btn * { pointer-events: none !important; }
.export-btn:hover:not(:disabled) { transform: translateY(-2px); border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 4px 20px rgba(0, 255, 65, 0.3); }
.export-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.export-btn.primary { background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000 !important; border: none; font-weight: 900; box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); padding: 18px 40px; font-size: 1.1rem; min-width: 200px; }
.export-btn.primary:hover:not(:disabled) { box-shadow: 0 6px 30px rgba(0, 255, 65, 0.6); }
.export-btn.reset { background: linear-gradient(135deg, var(--accent-red) 0%, #991b1b 100%); color: #fff !important; box-shadow: 0 0 10px rgba(220, 38, 38, 0.3); }
.export-btn.reset:hover:not(:disabled) { box-shadow: 0 4px 20px rgba(220, 38, 38, 0.5); }

.autosave-indicator { position: fixed; bottom: 60px; right: 15px; background: rgba(0, 0, 0, 0.9); border: 1px solid var(--border-color); border-radius: 5px; padding: 5px 9px; font-size: 0.7rem; color: var(--text-secondary); z-index: 1000; opacity: 0; transition: opacity 0.3s; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); }
.autosave-indicator.saving, .autosave-indicator.saved { opacity: 1; color: var(--accent-green); border-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
.autosave-indicator.saving { animation: pulse 1s ease-in-out; }

.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay.active { display: flex; }
.loading-content { text-align: center; }
.loading-spinner { width: 45px; height: 45px; border: 3px solid var(--border-color); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); }
.loading-text { font-size: 0.95rem; color: var(--accent-green); font-weight: 700; }
.success-message { background: linear-gradient(135deg, rgba(0, 255, 65, 0.1) 0%, rgba(0, 255, 65, 0.05) 100%); border: 2px solid var(--accent-green); border-radius: 8px; padding: 20px; max-width: 450px; margin: 0 auto; text-align: center; box-shadow: 0 0 40px rgba(0, 255, 65, 0.3); }
.success-icon { font-size: 2.2rem; color: var(--accent-green); margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(0, 255, 65, 0.5)); }
.success-title { font-size: 1.2rem; color: var(--accent-green); font-weight: 800; margin-bottom: 10px; }
.success-link { background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); color: var(--accent-green); padding: 8px; border-radius: 5px; margin: 10px 0; word-break: break-all; font-family: monospace; font-size: 0.75rem; }
.success-actions { display: flex; gap: 7px; justify-content: center; margin-top: 12px; }
.close-success-btn, .copy-success-btn { padding: 7px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; font-size: 0.8rem; transition: all 0.3s; }
.close-success-btn { background: linear-gradient(135deg, var(--accent-green) 0%, #00cc33 100%); color: #000; }
.close-success-btn:hover { box-shadow: 0 4px 15px rgba(0, 255, 65, 0.5); }
.copy-success-btn { background: rgba(0, 0, 0, 0.8); color: var(--accent-green); border: 1px solid var(--accent-green); }
.copy-success-btn:hover { box-shadow: 0 4px 15px rgba(0, 255, 65, 0.5); }

/* CC Timeline Visual Output Styles - Multi-Lane Layout */
.cc-chains-container { margin: 10px 0; }
.cc-chain-wrapper { position: relative; margin-bottom: 15px; }
.cc-timeline-visual { background: linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(10,10,10,0.9) 100%); border: 2px solid rgba(0, 255, 65, 0.4); border-radius: 10px; padding: 15px; overflow-x: auto; }
.cc-timeline-header { font-size: 0.9rem; font-weight: 800; color: #00ff41; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; text-align: center; text-shadow: 0 0 10px rgba(0,255,65,0.5); }

/* Ruler row */
.cc-ruler-row { display: flex; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.cc-ruler { flex: 1; position: relative; height: 20px; margin-left: 10px; }
.cc-tick { position: absolute; font-size: 0.65rem; color: #666; transform: translateX(-50%); }

/* Player rows */
.cc-player-row { display: flex; align-items: center; margin-bottom: 8px; min-height: 44px; }
.cc-player-label { width: 90px; flex-shrink: 0; display: flex; align-items: center; gap: 6px; padding-right: 10px; }
.cc-player-icon { width: 28px; height: 28px; border-radius: 4px; border: 2px solid rgba(0,255,65,0.3); }
.cc-player-label span { font-size: 0.7rem; font-weight: 700; color: #00ff41; text-transform: uppercase; }
.cc-player-track { flex: 1; position: relative; height: 40px; background: rgba(0,0,0,0.4); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }

/* Ability bars */
.cc-ability-bar { position: absolute; top: 4px; height: 32px; border-radius: 4px; display: flex; align-items: center; gap: 5px; padding: 0 8px; font-weight: 700; border: 2px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.5); overflow: hidden; white-space: nowrap; transition: transform 0.2s, z-index 0.2s; cursor: pointer; }
.cc-ability-bar:hover { transform: scale(1.08) translateY(-2px); z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.7); }
.cc-ability-icon { width: 22px; height: 22px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.3); }
.cc-ability-text { font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; }
.cc-ability-target { font-size: 0.6rem; opacity: 0.9; margin-left: auto; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px; }

/* Legend */
.cc-timeline-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); justify-content: center; }
.cc-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: #aaa; }
.cc-legend-dot { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.2); }

/* Delete button */
.delete-cc-chain { display: block; margin: 10px auto 0; background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(220, 38, 38, 0.4); color: #ff6666; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: 600; transition: all 0.3s; }
.delete-cc-chain:hover { background: rgba(220, 38, 38, 0.3); border-color: #ff4444; color: #fff; }

@media (max-width: 968px) {
  .sb-container { padding: 0 15px; }
  .team-comparison { grid-template-columns: 1fr; }
  .map-grid { grid-template-columns: repeat(2, 1fr); }
  .cc-modal-content { grid-template-columns: 1fr; }
  .ability-library { max-height: 300px; }
  .target-assignment-grid { grid-template-columns: 1fr; }
  .published-container { padding: 30px 20px 80px; }
  .published-content { padding: 30px 25px; }
  .guide-title { font-size: 1.8rem; }
  .guide-section-header { font-size: 1.4rem; }
  .matchup-teams { grid-template-columns: 1fr; gap: 15px; }
  .matchup-vs { transform: rotate(90deg); }
}

@media (max-width: 640px) {
  .strategy-info { grid-template-columns: 1fr; }
  .sb-title { font-size: 1.2rem; }
  .bracket-selector, .faction-selector { flex-direction: column; }
  .selection-grid { grid-template-columns: repeat(2, 1fr); }
  .map-grid { grid-template-columns: 1fr; }
  .timeline-header { padding-left: 60px; }
  .timeline-player-label { width: 50px; font-size: 0.65rem; }
  .timeline-second, .timeline-cell { min-width: 40px; }
  .player-step-icon { width: 28px; height: 28px; }
  .player-step-name { font-size: 0.75rem; }
  .step-number { width: 24px; height: 24px; font-size: 0.75rem; }
  .step-title { font-size: 0.75rem; }
  .progress-indicator { flex-direction: column; gap: 8px; padding: 10px 15px; }
  .progress-bar-container { margin: 0; width: 100%; }
  .cc-modal { padding: 15px; max-width: 95vw; }
  .welcome-tooltip { padding: 25px 20px; max-width: 95%; }
  .publish-modal { max-width: 95%; }
  .publish-modal-header { padding: 20px; }
  .publish-modal-title { font-size: 1.1rem; }
  .publish-modal-body { padding: 20px; }
  .publish-option-btn { padding: 15px; }
  .publish-option-icon { font-size: 2rem; }
}

.ability-library::-webkit-scrollbar, .timeline-container::-webkit-scrollbar, .cc-modal::-webkit-scrollbar { width: 6px; height: 6px; }
.ability-library::-webkit-scrollbar-track, .timeline-container::-webkit-scrollbar-track, .cc-modal::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 3px; }
.ability-library::-webkit-scrollbar-thumb, .timeline-container::-webkit-scrollbar-thumb, .cc-modal::-webkit-scrollbar-thumb { background: var(--accent-green); border-radius: 3px; }
.ability-library::-webkit-scrollbar-thumb:hover, .timeline-container::-webkit-scrollbar-thumb:hover, .cc-modal::-webkit-scrollbar-thumb:hover { background: #00cc33; }
</style>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="strategy-builder-v1">
  <div class="sb-container">
    <div class="sb-header">
      <img src="https://cdn.shopify.com/s/files/1/0964/2609/8968/files/emptybg-processed-tbc20thlogorraw-20251219T060547_1.png?v=1766431386" alt="TBC" class="sb-logo">
      <h1 class="sb-title">Arena Strategy Builder</h1>
    </div>
    <div class="strategy-info">
      <div class="info-field">
        <div class="info-label">Strategy Title</div>
        <input type="text" id="strategyTitle" class="info-input" placeholder="">
      </div>
      <div class="info-field">
        <div class="info-label">Author Name</div>
        <input type="text" id="authorName" class="info-input" placeholder="">
      </div>
    </div>
    <div class="bracket-section">
      <div class="bracket-label">⚔️ Select Bracket</div>
      <div class="bracket-selector">
        <button class="bracket-btn" data-bracket="2v2">2v2</button>
        <button class="bracket-btn" data-bracket="3v3">3v3</button>
        <button class="bracket-btn" data-bracket="5v5">5v5</button>
      </div>
    </div>
    <div class="team-comparison">
      <div class="team-builder">
        <div class="team-header">⚔️ Your Team</div>
        <div class="faction-selector">
          <div class="faction-btn alliance" data-faction="Alliance" data-team="your">
            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_bannerpvp_02.jpg" class="faction-icon">
            <span class="faction-name">Alliance</span>
          </div>
          <div class="faction-btn horde" data-faction="Horde" data-team="your">
            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_bannerpvp_01.jpg" class="faction-icon">
            <span class="faction-name">Horde</span>
          </div>
          <div class="faction-btn both" data-faction="Both" data-team="your">
            <span class="faction-name">Both</span>
          </div>
        </div>
        <div class="player-slots" id="yourPlayers"></div>
      </div>
      <div class="team-builder">
        <div class="team-header">🛡️ Enemy Team</div>
        <div class="faction-selector">
          <div class="faction-btn alliance" data-faction="Alliance" data-team="enemy">
            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_bannerpvp_02.jpg" class="faction-icon">
            <span class="faction-name">Alliance</span>
          </div>
          <div class="faction-btn horde" data-faction="Horde" data-team="enemy">
            <img src="https://wow.zamimg.com/images/wow/icons/large/inv_bannerpvp_01.jpg" class="faction-icon">
            <span class="faction-name">Horde</span>
          </div>
          <div class="faction-btn both" data-faction="Both" data-team="enemy">
            <span class="faction-name">Both</span>
          </div>
        </div>
        <div class="player-slots" id="enemyPlayers"></div>
      </div>
    </div>
    <div class="kill-target-section">
      <div class="kill-target-label">🎯 Assign Kill & CC Targets</div>
      <div class="target-assignment-grid">
        <div class="enemy-pool">
          <div class="pool-label">Enemy Team</div>
          <div class="enemy-icons-pool" id="enemyIconsPool"></div>
        </div>
        <div class="assignment-zone kill" id="killZone">
          <div class="zone-label kill">🔴 KILL TARGET</div>
          <div class="assigned-targets" id="killTargets"></div>
        </div>
        <div class="assignment-zone cc" id="ccZone">
          <div class="zone-label cc">⚫ CC TARGETS</div>
          <div class="assigned-targets" id="ccTargets"></div>
        </div>
      </div>
    </div>
    <div class="map-section">
      <div class="map-section-label">📍 Select Arena Map</div>
      <div class="map-grid">
        <div class="map-option" data-map="All Maps">
          <div style="height:80px;display:flex;align-items:center;justify-content:center;background:rgba(0,255,65,0.1);">
            <span style="font-size:2rem;">🌍</span>
          </div>
          <div class="map-name">All Maps</div>
        </div>
        <div class="map-option" data-map="Blade's Edge Arena">
          <img src="https://cdn.shopify.com/s/files/1/0964/2609/8968/files/edge_1.webp?v=1766559329" class="map-image">
          <div class="map-name">Blade's Edge</div>
        </div>
        <div class="map-option" data-map="Nagrand Arena">
          <img src="https://cdn.shopify.com/s/files/1/0964/2609/8968/files/OIP_1.webp?v=1766559348" class="map-image">
          <div class="map-name">Nagrand</div>
        </div>
        <div class="map-option" data-map="Ruins of Lordaeron">
          <img src="https://cdn.shopify.com/s/files/1/0964/2609/8968/files/OIP.webp?v=1766558961" class="map-image">
          <div class="map-name">Lordaeron</div>
        </div>
      </div>
    </div>
    <div class="progress-indicator" id="progressIndicator">
      <span class="progress-text">Strategy Progress</span>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <span class="progress-count" id="progressCount">0/5</span>
    </div>
    <div class="strategy-sections">
      <div class="strategy-section">
        <div class="section-header" data-section="opener">
          <span class="section-title">🎯 Opener</span>
          <span class="section-icon">▼</span>
        </div>
        <div class="section-content active" id="openerSection">
          <div class="steps-container" id="openerSteps"></div>
          <button class="add-step-btn" data-section="opener">+ Add Step</button>
        </div>
      </div>
      <div class="strategy-section">
        <div class="section-header" data-section="midgame">
          <span class="section-title">⚡ Mid Game</span>
          <span class="section-icon">▼</span>
        </div>
        <div class="section-content active" id="midgameSection">
          <div class="steps-container" id="midgameSteps"></div>
          <button class="add-step-btn" data-section="midgame">+ Add Step</button>
        </div>
      </div>
      <div class="strategy-section">
        <div class="section-header" data-section="wincondition">
          <span class="section-title">🏆 Win Condition</span>
          <span class="section-icon">▼</span>
        </div>
        <div class="section-content active" id="winconditionSection">
          <div class="steps-container" id="winconditionSteps"></div>
          <button class="add-step-btn" data-section="wincondition">+ Add Step</button>
        </div>
      </div>
      <div class="strategy-section">
        <div class="section-header" data-section="matchupnotes">
          <span class="section-title">💡 Matchup Notes</span>
          <span class="section-icon">▼</span>
        </div>
        <div class="section-content active" id="matchupnotesSection">
          <div class="steps-container" id="matchupnotesSteps"></div>
          <button class="add-step-btn" data-section="matchupnotes">+ Add Step</button>
        </div>
      </div>
      <div class="strategy-section">
        <div class="section-header" data-section="map">
          <span class="section-title">📍 Map Considerations</span>
          <span class="section-icon">▼</span>
        </div>
        <div class="section-content active" id="mapSection">
          <div class="steps-container" id="mapSteps"></div>
          <button class="add-step-btn" data-section="map">+ Map Notes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="cc-modal-overlay" id="ccModalOverlay">
  <div class="cc-modal">
    <div class="cc-modal-header">
      <div class="cc-modal-title">⚡ Build CC Chain</div>
      <button class="cc-modal-close" id="closeCCModal">×</button>
    </div>
    <div class="cc-modal-content">
      <div class="ability-library" id="abilityLibrary">
        <div class="ability-library-header">Drag Abilities →</div>
        <input type="text" id="abilitySearch" class="ability-search" placeholder="Search abilities...">
        <div id="abilityGroups"></div>
      </div>
      <div class="timeline-container">
        <div class="timeline-header" id="timelineHeader"></div>
        <div class="timeline-rows" id="timelineRows"></div>
      </div>
    </div>
    <div class="cc-modal-footer">
      <button class="cc-modal-btn secondary" id="clearChain">Clear Chain</button>
      <button class="cc-modal-btn primary" id="insertChain">Insert Chain</button>
    </div>
  </div>
</div>

<div class="target-modal-overlay" id="targetModalOverlay">
  <div class="target-modal">
    <div class="target-modal-title">Select Target</div>
    <div class="target-grid" id="targetGrid"></div>
    <button class="target-modal-cancel" id="cancelTargetSelection">Cancel</button>
  </div>
</div>

<div class="export-toolbar">
  <button class="export-btn primary" id="publishBtn" onclick="window.handlePublish(); return false;">Publish Strategy</button>
  <button class="export-btn reset" id="resetBtn" onclick="window.handleReset(); return false;">Reset</button>
</div>

<div class="modal-overlay" id="publishOverlay"></div>
<div class="publish-modal" id="publishModal">
  <div class="publish-modal-header">
    <div class="publish-modal-title">🚀 Publish Your Strategy</div>
    <button class="publish-modal-close" id="closePublishModal">×</button>
  </div>
  <div class="publish-modal-body">
    <p class="publish-description">Your strategy is ready! Choose how you want to share it:</p>
    <div class="publish-options">
      <button class="publish-option-btn" id="publishDownloadPDF">
        <div class="publish-option-icon">📄</div>
        <div class="publish-option-content">
          <div class="publish-option-title">Download PDF</div>
          <div class="publish-option-desc">Save a formatted PDF to your device</div>
        </div>
      </button>
      <button class="publish-option-btn" id="publishGenerateLink">
        <div class="publish-option-icon">🔗</div>
        <div class="publish-option-content">
          <div class="publish-option-title">Generate Share Link</div>
          <div class="publish-option-desc">Create a URL to share with your team</div>
        </div>
      </button>
      <button class="publish-option-btn" id="publishViewGuide">
        <div class="publish-option-icon">📖</div>
        <div class="publish-option-content">
          <div class="publish-option-title">View as Matchup Guide</div>
          <div class="publish-option-desc">Preview as a professional article</div>
        </div>
      </button>
    </div>
  </div>
</div>

<div class="published-view-overlay" id="publishedViewOverlay"></div>
<div class="published-view" id="publishedView">
  <div class="published-container">
    <button class="published-close-btn" id="closePublishedView">← Back to Editor</button>
    <div class="published-content" id="publishedContent"></div>
    <div class="published-actions">
      <button class="published-action-btn" id="downloadFromPublished">📄 Download PDF</button>
      <button class="published-action-btn" id="shareFromPublished">🔗 Share Link</button>
    </div>
  </div>
</div>

<div class="welcome-overlay" id="welcomeOverlay"></div>
<div class="welcome-tooltip" id="welcomeTooltip">
  <div class="welcome-title">🎮 Arena Strategy Builder</div>
  <div class="welcome-subtitle">Build your own custom arena playbook fast and easy!</div>
  <div class="welcome-steps">
    <div class="welcome-step">
      <div class="welcome-step-number">1</div>
      <div class="welcome-step-content">
        <div class="welcome-step-title">Input Your Teams</div>
        <div class="welcome-step-desc">Select bracket (2v2/3v3/5v5), pick your comp and enemy comp</div>
      </div>
    </div>
    <div class="welcome-step">
      <div class="welcome-step-number">2</div>
      <div class="welcome-step-content">
        <div class="welcome-step-title">Assign Kill & CC Targets</div>
        <div class="welcome-step-desc">Drag enemy class icons to kill target and CC target zones</div>
      </div>
    </div>
    <div class="welcome-step">
      <div class="welcome-step-number">3</div>
      <div class="welcome-step-content">
        <div class="welcome-step-title">Build Your Strategy</div>
        <div class="welcome-step-desc">Fill in Opener, Mid Game, Win Condition, and Map sections. Add CC chains with visual timelines.</div>
      </div>
    </div>
    <div class="welcome-step">
      <div class="welcome-step-number">4</div>
      <div class="welcome-step-content">
        <div class="welcome-step-title">Export & Share</div>
        <div class="welcome-step-desc">Generate a shareable link or download as PDF when complete</div>
      </div>
    </div>
  </div>
  <div class="welcome-actions">
    <button class="welcome-btn" id="closeWelcome">Let's Build! 🚀</button>
  </div>
</div>

<div class="undo-toast" id="undoToast">
  <span class="undo-toast-text" id="undoToastText">Step deleted</span>
  <button class="undo-btn" id="undoBtn">Undo</button>
</div>

<div class="autosave-indicator" id="autosaveIndicator">
  <span id="autosaveText">Saved</span>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
  </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
(function() {
  'use strict';

  const DATA = {
    classes: {
      Warrior: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/war.png?v=1766427831', specs: ['Arms', 'Fury', 'Protection'] },
      Paladin: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/pala.png?v=1766427831', specs: ['Holy', 'Retribution', 'Protection'] },
      Hunter: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/hunter.png?v=1766427832', specs: ['Survival', 'Marksmanship', 'Beast Mastery'] },
      Rogue: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/rogue.png?v=1766427831', specs: ['Subtlety', 'Mutilate', 'Combat'] },
      Priest: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/priest.png?v=1766427831', specs: ['Discipline', 'Shadow', 'Holy'] },
      Shaman: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/shaman.png?v=1766427831', specs: ['Restoration', 'Enhancement', 'Elemental'] },
      Mage: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/mage.png?v=1766427831', specs: ['Frost', 'Fire', 'Arcane'] },
      Warlock: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/warlock.png?v=1766427831', specs: ['SL/SL', 'Affliction', 'Destruction'] },
      Druid: { icon: 'https://cdn.shopify.com/s/files/1/0964/2609/8968/files/druid.png?v=1766427831', specs: ['Restoration', 'Feral', 'Balance'] }
    },
    specIcons: {
      'Arms': 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_savageblow.jpg',
      'Fury': 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_innerrage.jpg',
      'Protection': 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_defensivestance.jpg',
      'Holy': 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_holybolt.jpg',
      'Retribution': 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_auraoflight.jpg',
      'Beast Mastery': 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_beasttaming.jpg',
      'Marksmanship': 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_focusedaim.jpg',
      'Survival': 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_swiftstrike.jpg',
      'Mutilate': 'https://wow.zamimg.com/images/wow/icons/large/ability_rogue_shadowstrikes.jpg',
      'Combat': 'https://wow.zamimg.com/images/wow/icons/large/ability_backstab.jpg',
      'Subtlety': 'https://wow.zamimg.com/images/wow/icons/large/ability_stealth.jpg',
      'Discipline': 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_wordfortitude.jpg',
      'Shadow': 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_shadowwordpain.jpg',
      'Elemental': 'https://wow.zamimg.com/images/wow/icons/large/spell_lightning_lightningbolt01.jpg',
      'Enhancement': 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_lightningshield.jpg',
      'Restoration': 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_magicimmunity.jpg',
      'Restoration-Druid': 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_healingtouch.jpg',
      'Arcane': 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_magicalsentry.jpg',
      'Fire': 'https://wow.zamimg.com/images/wow/icons/large/spell_fire_firebolt02.jpg',
      'Frost': 'https://wow.zamimg.com/images/wow/icons/large/spell_frost_frostbolt02.jpg',
      'Affliction': 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_unstableaffliction_3.jpg',
      'SL/SL': 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_antishadow.jpg',
      'Destruction': 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_rainoffire.jpg',
      'Balance': 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_starfall.jpg',
      'Feral': 'https://wow.zamimg.com/images/wow/icons/large/ability_druid_catform.jpg'
    },
    getSpecIcon: function(className, specName) {
      if (specName === 'Restoration' && className === 'Druid') return this.specIcons['Restoration-Druid'];
      return this.specIcons[specName];
    },
    // Race priority by class for most popular picks
    racePriority: {
      Alliance: {
        Rogue: ['Human', 'Dwarf', 'Night Elf', 'Gnome'],
        Priest: ['Dwarf', 'Human', 'Night Elf', 'Draenei'],
        Hunter: ['Dwarf', 'Night Elf', 'Draenei'],
        Paladin: ['Dwarf', 'Human', 'Draenei'],
        Mage: ['Gnome', 'Human', 'Draenei'],
        Warlock: ['Gnome', 'Human'],
        Warrior: ['Human', 'Dwarf', 'Night Elf', 'Gnome', 'Draenei'],
        Druid: ['Night Elf']
      },
      Horde: {
        Rogue: ['Undead', 'Orc', 'Troll', 'Blood Elf'],
        Priest: ['Undead', 'Troll', 'Blood Elf'],
        Warlock: ['Undead', 'Orc', 'Blood Elf'],
        Mage: ['Undead', 'Troll', 'Blood Elf'],
        Hunter: ['Orc', 'Tauren', 'Troll', 'Blood Elf'],
        Warrior: ['Orc', 'Tauren', 'Undead', 'Troll'],
        Shaman: ['Orc', 'Tauren', 'Troll', 'Draenei'],
        Druid: ['Tauren'],
        Paladin: ['Blood Elf']
      }
    },
    getRacesForClass: function(faction, className) {
      const priority = this.racePriority[faction]?.[className] || [];
      const factionRaces = this.races[faction];
      const validRaces = [];
      // Add prioritized races first
      priority.forEach(raceName => {
        if (factionRaces[raceName] && factionRaces[raceName].classes.includes(className)) {
          validRaces.push({ name: raceName, ...factionRaces[raceName] });
        }
      });
      // Add any remaining valid races
      Object.keys(factionRaces).forEach(raceName => {
        if (!priority.includes(raceName) && factionRaces[raceName].classes.includes(className)) {
          validRaces.push({ name: raceName, ...factionRaces[raceName] });
        }
      });
      return validRaces;
    },
    races: {
      Alliance: {
        Human: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_human_male.jpg', classes: ['Warrior', 'Paladin', 'Rogue', 'Priest', 'Mage', 'Warlock'] },
        Dwarf: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_dwarf_male.jpg', classes: ['Warrior', 'Paladin', 'Hunter', 'Rogue', 'Priest'] },
        'Night Elf': { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_nightelf_male.jpg', classes: ['Warrior', 'Hunter', 'Rogue', 'Priest', 'Druid'] },
        Gnome: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_gnome_male.jpg', classes: ['Warrior', 'Rogue', 'Mage', 'Warlock'] },
        Draenei: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_draenei_male.jpg', classes: ['Warrior', 'Paladin', 'Hunter', 'Priest', 'Shaman', 'Mage'] }
      },
      Horde: {
        Orc: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_orc_male.jpg', classes: ['Warrior', 'Hunter', 'Rogue', 'Shaman', 'Warlock'] },
        Undead: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_scourge_male.jpg', classes: ['Warrior', 'Rogue', 'Priest', 'Mage', 'Warlock'] },
        Tauren: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_tauren_male.jpg', classes: ['Warrior', 'Hunter', 'Shaman', 'Druid'] },
        Troll: { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_troll_male.jpg', classes: ['Warrior', 'Hunter', 'Rogue', 'Priest', 'Shaman', 'Mage'] },
        'Blood Elf': { icon: 'https://wow.zamimg.com/images/wow/icons/medium/race_bloodelf_male.jpg', classes: ['Paladin', 'Hunter', 'Rogue', 'Priest', 'Mage', 'Warlock'] }
      },
      Both: {}
    },
    // FIXED: TBC PvP durations - Hex removed (WotLK only)
    abilities: {
      Rogue: {
        'Sap': { icon: 'ability_sap', type: 'incapacitate', duration: '10s' },
        'Cheap Shot': { icon: 'ability_cheapshot', type: 'stun', duration: '4s' },
        'Kidney Shot': { icon: 'ability_rogue_kidneyshot', type: 'stun', duration: '1-6s' },
        'Blind': { icon: 'spell_shadow_mindsteal', type: 'disorient', duration: '10s' },
        'Gouge': { icon: 'ability_gouge', type: 'incapacitate', duration: '5.5s' },
        'Kick': { icon: 'ability_kick', type: 'silence', duration: '5s' }
      },
      Priest: {
        'Psychic Scream': { icon: 'spell_shadow_psychicscream', type: 'fear', duration: '8s' },
        'Shackle Undead': { icon: 'spell_nature_slow', type: 'shackle', duration: '10s' },
        'Silence': { icon: 'spell_shadow_impphaseshift', type: 'silence', duration: '5s' }
      },
      Mage: {
        'Polymorph': { icon: 'spell_nature_polymorph', type: 'poly', duration: '10s' },
        'Counterspell': { icon: 'spell_frost_iceshock', type: 'silence', duration: '8s' },
        'Frost Nova': { icon: 'spell_frost_frostnova', type: 'root', duration: '8s' }
      },
      Warlock: {
        'Fear': { icon: 'spell_shadow_possession', type: 'fear', duration: '10s' },
        'Howl of Terror': { icon: 'spell_shadow_deathscream', type: 'fear', duration: '8s' },
        'Seduction': { icon: 'spell_shadow_mindsteal', type: 'seduce', duration: '10s' },
        'Spell Lock': { icon: 'spell_shadow_mindrot', type: 'silence', duration: '6s' },
        'Death Coil': { icon: 'spell_shadow_deathcoil', type: 'fear', duration: '3s' }
      },
      Druid: {
        'Cyclone': { icon: 'spell_nature_earthbind', type: 'cyclone', duration: '6s' },
        'Entangling Roots': { icon: 'spell_nature_stranglevines', type: 'root', duration: '12s' },
        'Hibernate': { icon: 'spell_nature_sleep', type: 'sleep', duration: '10s' },
        'Bash': { icon: 'ability_druid_bash', type: 'stun', duration: '4s' },
        'Feral Charge': { icon: 'ability_hunter_pet_bear', type: 'stun', duration: '4s' }
      },
      Shaman: {
        'Grounding Totem': { icon: 'spell_nature_groundingtotem', type: 'utility', duration: '45s' },
        'Earthbind Totem': { icon: 'spell_nature_strengthofearthtotem02', type: 'slow', duration: '45s' },
        'Earth Shock': { icon: 'spell_nature_earthshock', type: 'silence', duration: '2s' }
      },
      Paladin: {
        'Hammer of Justice': { icon: 'spell_holy_sealofmight', type: 'stun', duration: '6s' },
        'Repentance': { icon: 'spell_holy_prayerofhealing', type: 'incapacitate', duration: '10s' },
        'Turn Evil': { icon: 'spell_holy_turnundead', type: 'fear', duration: '10s' }
      },
      Warrior: {
        'Intimidating Shout': { icon: 'ability_golemthunderclap', type: 'fear', duration: '8s' },
        'Concussion Blow': { icon: 'ability_thunderbolt', type: 'stun', duration: '5s' },
        'Pummel': { icon: 'inv_gauntlets_04', type: 'silence', duration: '4s' },
        'Intercept': { icon: 'ability_rogue_sprint', type: 'stun', duration: '3s' },
        'Mace Stun': { icon: 'ability_warrior_weaponmastery', type: 'stun', duration: '3s' }
      },
      Hunter: {
        'Freezing Trap': { icon: 'spell_frost_chainsofice', type: 'freeze', duration: '10s' },
        'Wyvern Sting': { icon: 'inv_spear_02', type: 'sleep', duration: '10s' },
        'Scatter Shot': { icon: 'ability_golemstormbolt', type: 'disorient', duration: '4s' },
        'Silencing Shot': { icon: 'ability_theblackarrow', type: 'silence', duration: '3s' },
        'Intimidation': { icon: 'ability_devour', type: 'stun', duration: '3s' }
      }
    }
  };

  let state = { 
    title: '', bracket: null, 
    yourTeam: { faction: null, players: [] }, 
    enemyTeam: { faction: null, players: [] }, 
    killTargets: [], ccTargets: [], map: null, 
    sections: { map: [], opener: [], midgame: [], wincondition: [], matchupnotes: [] }, 
    editors: {}, sortables: {} 
  };

  let saveTimeout = null, draggedAbility = null, draggedEnemy = null;
  let currentCCChain = [], currentStepId = null, pendingDrop = null;

  function loadState() {
    const saved = localStorage.getItem('tbc_strategy_builder');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        state = { ...state, ...parsed, editors: {}, sortables: {} };
        if (!state.killTargets) state.killTargets = [];
        if (!state.ccTargets) state.ccTargets = [];
      } catch (e) {}
    }
  }

  function saveState() {
    clearTimeout(saveTimeout);
    const indicator = document.getElementById('autosaveIndicator');
    const text = document.getElementById('autosaveText');
    indicator.classList.remove('saved'); indicator.classList.add('saving');
    text.textContent = 'Saving...';
    saveTimeout = setTimeout(() => {
      try {
        localStorage.setItem('tbc_strategy_builder', JSON.stringify({ 
          title: state.title, bracket: state.bracket, yourTeam: state.yourTeam, 
          enemyTeam: state.enemyTeam, killTargets: state.killTargets, ccTargets: state.ccTargets,
          map: state.map, sections: state.sections 
        }));
        indicator.classList.remove('saving'); indicator.classList.add('saved');
        text.textContent = 'Saved ✓';
        setTimeout(() => indicator.classList.remove('saved'), 2000);
        updateProgress(); updateSectionCompletionStates();
      } catch (e) { text.textContent = 'Save failed'; }
    }, 500);
  }

  function updateProgress() {
    const totalSections = 5;
    const completedSections = Object.keys(state.sections).filter(key => 
      state.sections[key].length > 0 && state.sections[key].some(step => step.content && step.content.trim().length > 0)
    ).length;
    const percentage = (completedSections / totalSections) * 100;
    const progressBar = document.getElementById('progressBar');
    const progressCount = document.getElementById('progressCount');
    if (progressBar) progressBar.style.width = percentage + '%';
    if (progressCount) progressCount.textContent = completedSections + '/' + totalSections;
  }

  function updateSectionCompletionStates() {
    Object.keys(state.sections).forEach(sectionKey => {
      const section = document.querySelector('.strategy-section .section-header[data-section="' + sectionKey + '"]')?.closest('.strategy-section');
      if (!section) return;
      const hasContent = state.sections[sectionKey].length > 0 && state.sections[sectionKey].some(step => step.content && step.content.trim().length > 0);
      if (hasContent) { section.classList.add('completed'); section.classList.remove('empty'); }
      else { section.classList.remove('completed'); section.classList.add('empty'); }
    });
  }

  function openCCModal(stepId) {
    currentStepId = stepId; currentCCChain = [];
    document.getElementById('ccModalOverlay').classList.add('active');
    renderAbilityLibrary(); renderTimeline();
  }

  function closeCCModal() {
    document.getElementById('ccModalOverlay').classList.remove('active');
    currentStepId = null; currentCCChain = [];
  }

  function renderAbilityLibrary() {
    const container = document.getElementById('abilityGroups');
    container.innerHTML = '';
    const yourClasses = state.yourTeam.players.filter(p => p.class).map(p => p.class);
    if (yourClasses.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">Select your team first</div>';
      return;
    }
    Object.keys(DATA.abilities).forEach(className => {
      if (!yourClasses.includes(className)) return;
      const group = document.createElement('div');
      group.className = 'ability-class-group';
      group.innerHTML = '<div class="ability-class-name">' + className + '</div>';
      const list = document.createElement('div');
      list.className = 'ability-list';
      Object.keys(DATA.abilities[className]).forEach(abilityName => {
        const ability = DATA.abilities[className][abilityName];
        const item = document.createElement('div');
        item.className = 'ability-item ' + ability.type;
        item.draggable = true;
        item.dataset.class = className;
        item.dataset.ability = abilityName;
        item.dataset.type = ability.type;
        item.dataset.icon = ability.icon;
        item.dataset.duration = ability.duration;
        item.innerHTML = '<img src="https://wow.zamimg.com/images/wow/icons/large/' + ability.icon + '.jpg" class="ability-icon"><div class="ability-name">' + abilityName + '</div><div class="ability-duration">' + ability.duration + '</div>';
        item.addEventListener('dragstart', (e) => {
          draggedAbility = { class: className, name: abilityName, type: ability.type, icon: ability.icon, duration: ability.duration };
          e.dataTransfer.effectAllowed = 'copy';
        });
        list.appendChild(item);
      });
      group.appendChild(list);
      container.appendChild(group);
    });
  }

  function renderTimeline() {
    const header = document.getElementById('timelineHeader');
    header.innerHTML = '';
    for (let i = 0; i <= 60; i += 5) {
      const sec = document.createElement('div');
      sec.className = 'timeline-second';
      sec.textContent = i + 's';
      header.appendChild(sec);
    }
    const rows = document.getElementById('timelineRows');
    rows.innerHTML = '';
    if (!state.yourTeam.players || state.yourTeam.players.length === 0) {
      rows.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">Select your team comp first</div>';
      return;
    }
    state.yourTeam.players.forEach((player, idx) => {
      if (!player.class) return;
      const row = document.createElement('div');
      row.className = 'timeline-row';
      const label = document.createElement('div');
      label.className = 'timeline-player-label';
      label.innerHTML = '<img src="' + DATA.classes[player.class].icon + '" class="timeline-player-icon"><span>' + player.class + '</span>';
      const grid = document.createElement('div');
      grid.className = 'timeline-grid';
      grid.dataset.player = idx;
      for (let i = 0; i <= 60; i += 5) {
        const cell = document.createElement('div');
        cell.className = 'timeline-cell';
        cell.dataset.time = i;
        cell.dataset.player = idx;
        cell.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drop-target'); });
        cell.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('drop-target'); });
        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove('drop-target');
          if (draggedAbility) {
            pendingDrop = { ability: draggedAbility, time: parseInt(cell.dataset.time), player: parseInt(cell.dataset.player) };
            showTargetSelector();
          }
        });
        const existing = currentCCChain.find(cc => cc.time === i && cc.player === idx);
        if (existing) renderPlacedAbility(cell, existing);
        grid.appendChild(cell);
      }
      row.appendChild(label);
      row.appendChild(grid);
      rows.appendChild(row);
    });
  }

  function showTargetSelector() {
    const grid = document.getElementById('targetGrid');
    grid.innerHTML = '';
    state.enemyTeam.players.forEach((player, idx) => {
      if (!player.class) return;
      const option = document.createElement('div');
      option.className = 'target-option';
      option.innerHTML = '<img src="' + DATA.classes[player.class].icon + '" class="target-option-icon"><div class="target-option-name">' + player.class + '</div>';
      option.addEventListener('click', () => { selectTarget(idx); });
      grid.appendChild(option);
    });
    document.getElementById('targetModalOverlay').classList.add('active');
  }

  function selectTarget(targetIdx) {
    if (!pendingDrop) return;
    const cc = {
      id: 'cc_' + Date.now(),
      time: pendingDrop.time,
      player: pendingDrop.player,
      ability: pendingDrop.ability.name,
      icon: pendingDrop.ability.icon,
      type: pendingDrop.ability.type,
      duration: pendingDrop.ability.duration,
      target: targetIdx
    };
    currentCCChain.push(cc);
    renderTimeline();
    document.getElementById('targetModalOverlay').classList.remove('active');
    pendingDrop = null;
  }

  document.getElementById('cancelTargetSelection').addEventListener('click', () => {
    document.getElementById('targetModalOverlay').classList.remove('active');
    pendingDrop = null;
  });

  function renderPlacedAbility(cell, cc) {
    const placed = document.createElement('div');
    placed.className = 'placed-ability ' + cc.type;
    placed.dataset.ccId = cc.id;
    const targetPlayer = state.enemyTeam.players[cc.target];
    const targetName = targetPlayer ? targetPlayer.class || 'Enemy' : 'Enemy';
    placed.innerHTML = '<img src="https://wow.zamimg.com/images/wow/icons/large/' + cc.icon + '.jpg" class="placed-ability-icon"><div class="placed-ability-target">' + targetName + '</div><button class="remove-ability">×</button>';
    placed.querySelector('.remove-ability').addEventListener('click', (e) => {
      e.stopPropagation();
      currentCCChain = currentCCChain.filter(c => c.id !== cc.id);
      renderTimeline();
    });
    cell.appendChild(placed);
  }

  document.getElementById('clearChain').addEventListener('click', () => {
    if (confirm('Clear entire CC chain?')) { currentCCChain = []; renderTimeline(); }
  });

  document.getElementById('closeCCModal').addEventListener('click', closeCCModal);

  // Visual timeline generator - MULTI-LANE layout (one row per player)
  function generateVisualCCTimeline(chain) {
    if (!chain || chain.length === 0) return '';
    const sorted = [...chain].sort((a, b) => a.time - b.time);
    
    function parseDuration(dur) {
      if (!dur) return 5;
      const parts = dur.match(/(\d+)-(\d+)/);
      if (parts) return parseInt(parts[2]);
      const match = dur.match(/(\d+)/);
      return match ? parseInt(match[1]) : 5;
    }
    
    function getTypeColor(type) {
      const colors = {
        'stun': { bg: '#ff4444', border: '#ff6666' },
        'fear': { bg: '#8844aa', border: '#aa66cc' },
        'poly': { bg: '#4488ff', border: '#66aaff' },
        'root': { bg: '#44aa44', border: '#66cc66' },
        'silence': { bg: '#ff8844', border: '#ffaa66' },
        'incapacitate': { bg: '#ffcc00', border: '#ffdd44', text: '#000' },
        'disorient': { bg: '#ff66aa', border: '#ff88cc' },
        'cyclone': { bg: '#66ffcc', border: '#88ffdd', text: '#000' },
        'sleep': { bg: '#aa88ff', border: '#ccaaff' },
        'freeze': { bg: '#88ddff', border: '#aaeeff', text: '#000' },
        'shackle': { bg: '#888888', border: '#aaaaaa' },
        'seduce': { bg: '#ff4488', border: '#ff66aa' }
      };
      return colors[type] || colors.stun;
    }
    
    const maxTime = Math.max(...sorted.map(cc => cc.time + parseDuration(cc.duration))) + 5;
    const timelineWidth = Math.max(maxTime, 30);
    
    let totalDuration = 0;
    sorted.forEach(cc => totalDuration += parseDuration(cc.duration));
    
    // Group abilities by player
    const playerAbilities = {};
    sorted.forEach(cc => {
      if (!playerAbilities[cc.player]) playerAbilities[cc.player] = [];
      playerAbilities[cc.player].push(cc);
    });
    
    let html = '<div class="cc-timeline-visual">';
    html += '<div class="cc-timeline-header">⚡ CC CHAIN (' + totalDuration + 's total CC)</div>';
    
    // Time ruler header
    html += '<div class="cc-ruler-row"><div class="cc-player-label"></div><div class="cc-ruler">';
    for (let i = 0; i <= timelineWidth; i += 5) {
      const leftPct = (i / timelineWidth) * 100;
      html += '<span class="cc-tick" style="left:' + leftPct + '%;">' + i + 's</span>';
    }
    html += '</div></div>';
    
    // One row per player who has abilities
    Object.keys(playerAbilities).forEach(playerIdx => {
      const player = state.yourTeam.players[playerIdx];
      if (!player) return;
      
      html += '<div class="cc-player-row">';
      html += '<div class="cc-player-label"><img src="' + DATA.classes[player.class].icon + '" class="cc-player-icon"><span>' + player.class + '</span></div>';
      html += '<div class="cc-player-track">';
      
      playerAbilities[playerIdx].forEach(cc => {
        const duration = parseDuration(cc.duration);
        const leftPercent = (cc.time / timelineWidth) * 100;
        const widthPercent = (duration / timelineWidth) * 100;
        const colors = getTypeColor(cc.type);
        const textColor = colors.text || '#fff';
        const target = state.enemyTeam.players[cc.target];
        const targetName = target ? target.class : 'Enemy';
        
        html += '<div class="cc-ability-bar" style="left:' + leftPercent + '%;width:' + Math.max(widthPercent, 6) + '%;background:' + colors.bg + ';border-color:' + colors.border + ';color:' + textColor + ';" title="' + cc.ability + ' (' + cc.duration + ') → ' + targetName + '">';
        html += '<img class="cc-ability-icon" src="https://wow.zamimg.com/images/wow/icons/large/' + cc.icon + '.jpg">';
        html += '<span class="cc-ability-text">' + cc.ability + '</span>';
        html += '<span class="cc-ability-target">→ ' + targetName + '</span>';
        html += '</div>';
      });
      
      html += '</div></div>';
    });
    
    // Legend
    const usedTypes = [...new Set(sorted.map(cc => cc.type))];
    const typeLabels = { stun:'Stun', fear:'Fear', poly:'Polymorph', root:'Root', silence:'Silence', incapacitate:'Incapacitate', disorient:'Disorient', cyclone:'Cyclone', sleep:'Sleep', freeze:'Freeze', shackle:'Shackle', seduce:'Seduce' };
    html += '<div class="cc-timeline-legend">';
    usedTypes.forEach(type => {
      const colors = getTypeColor(type);
      html += '<span class="cc-legend-item"><span class="cc-legend-dot" style="background:' + colors.bg + ';"></span>' + (typeLabels[type] || type) + '</span>';
    });
    html += '</div></div>';
    
    return html;
  }

  // FIXED: Insert Chain saves to state, renders outside editor
  document.getElementById('insertChain').addEventListener('click', () => {
    if (currentCCChain.length === 0) { alert('Add abilities to the chain first!'); return; }
    
    // Find the step and section
    let targetSection = null;
    let targetStep = null;
    Object.keys(state.sections).forEach(section => {
      const step = state.sections[section].find(s => s.id === currentStepId);
      if (step) { targetSection = section; targetStep = step; }
    });
    
    if (!targetStep) { alert('Could not find step. Try again.'); return; }
    
    // Initialize ccChains array if needed
    if (!targetStep.ccChains) targetStep.ccChains = [];
    
    // Save the chain data (deep copy)
    const chainData = {
      id: 'chain_' + Date.now(),
      abilities: JSON.parse(JSON.stringify(currentCCChain))
    };
    targetStep.ccChains.push(chainData);
    
    // Re-render the CC chains for this step
    renderCCChains(targetSection, currentStepId);
    
    // Show success toast
    const toast = document.getElementById('undoToast');
    const toastText = document.getElementById('undoToastText');
    if (toast && toastText) {
      toastText.textContent = '✓ CC Chain added!';
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 2000);
    }
    
    closeCCModal();
    saveState();
  });

  // Render CC chains for a step (outside editor)
  function renderCCChains(section, stepId) {
    const container = document.getElementById('ccChains_' + stepId);
    if (!container) return;
    
    const stepData = state.sections[section].find(s => s.id === stepId);
    if (!stepData || !stepData.ccChains || stepData.ccChains.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    container.innerHTML = '';
    stepData.ccChains.forEach((chain, chainIdx) => {
      const chainEl = document.createElement('div');
      chainEl.className = 'cc-chain-wrapper';
      chainEl.innerHTML = generateVisualCCTimeline(chain.abilities) + 
        '<button class="delete-cc-chain" data-section="' + section + '" data-step-id="' + stepId + '" data-chain-idx="' + chainIdx + '">🗑️ Remove Chain</button>';
      container.appendChild(chainEl);
      
      chainEl.querySelector('.delete-cc-chain').addEventListener('click', function() {
        if (confirm('Delete this CC chain?')) {
          stepData.ccChains.splice(chainIdx, 1);
          renderCCChains(section, stepId);
          saveState();
        }
      });
    });
  }

  document.getElementById('abilitySearch').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.ability-item').forEach(item => {
      const name = item.querySelector('.ability-name').textContent.toLowerCase();
      item.style.display = name.includes(query) ? 'flex' : 'none';
    });
  });

  function renderEnemyPool() {
    const pool = document.getElementById('enemyIconsPool');
    pool.innerHTML = '';
    if (!state.enemyTeam.players || state.enemyTeam.players.length === 0) {
      pool.innerHTML = '<div class="empty-zone-text">Select enemy team first</div>';
      return;
    }
    state.enemyTeam.players.forEach((player, idx) => {
      if (!player.class) return;
      if (state.killTargets.includes(idx) || state.ccTargets.includes(idx)) return;
      const item = document.createElement('div');
      item.className = 'enemy-icon-item';
      item.draggable = true;
      item.dataset.enemyIndex = idx;
      item.innerHTML = '<img src="' + DATA.classes[player.class].icon + '" class="enemy-class-icon"><div class="enemy-class-name">' + player.class + '</div>';
      item.addEventListener('dragstart', (e) => { draggedEnemy = idx; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
      item.addEventListener('dragend', () => { item.classList.remove('dragging'); });
      pool.appendChild(item);
    });
    if (pool.children.length === 0) pool.innerHTML = '<div class="empty-zone-text">All enemies assigned</div>';
  }

  function renderAssignedTargets() {
    const killContainer = document.getElementById('killTargets');
    killContainer.innerHTML = '';
    if (state.killTargets.length === 0) {
      killContainer.innerHTML = '<div class="empty-zone-text">Drag enemy here</div>';
    } else {
      state.killTargets.forEach(enemyIdx => {
        const player = state.enemyTeam.players[enemyIdx];
        if (!player || !player.class) return;
        const item = document.createElement('div');
        item.className = 'assigned-target kill-target';
        item.innerHTML = '<img src="' + DATA.classes[player.class].icon + '" class="enemy-class-icon"><div class="enemy-class-name">' + player.class + '</div><button class="remove-assignment" data-zone="kill" data-index="' + enemyIdx + '">×</button>';
        item.querySelector('.remove-assignment').addEventListener('click', function() { removeAssignment('kill', enemyIdx); });
        killContainer.appendChild(item);
      });
    }
    const ccContainer = document.getElementById('ccTargets');
    ccContainer.innerHTML = '';
    if (state.ccTargets.length === 0) {
      ccContainer.innerHTML = '<div class="empty-zone-text">Drag enemies here</div>';
    } else {
      state.ccTargets.forEach(enemyIdx => {
        const player = state.enemyTeam.players[enemyIdx];
        if (!player || !player.class) return;
        const item = document.createElement('div');
        item.className = 'assigned-target cc-target';
        item.innerHTML = '<img src="' + DATA.classes[player.class].icon + '" class="enemy-class-icon"><div class="enemy-class-name">' + player.class + '</div><button class="remove-assignment" data-zone="cc" data-index="' + enemyIdx + '">×</button>';
        item.querySelector('.remove-assignment').addEventListener('click', function() { removeAssignment('cc', enemyIdx); });
        ccContainer.appendChild(item);
      });
    }
  }

  function removeAssignment(zone, enemyIdx) {
    if (zone === 'kill') state.killTargets = state.killTargets.filter(i => i !== enemyIdx);
    else state.ccTargets = state.ccTargets.filter(i => i !== enemyIdx);
    renderEnemyPool(); renderAssignedTargets(); saveState();
  }

  function setupDropZones() {
    const killZone = document.getElementById('killZone');
    const ccZone = document.getElementById('ccZone');
    [killZone, ccZone].forEach(zone => {
      zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drop-active'); });
      zone.addEventListener('dragleave', (e) => { if (e.target === zone) zone.classList.remove('drop-active'); });
      zone.addEventListener('drop', (e) => {
        e.preventDefault(); zone.classList.remove('drop-active');
        if (draggedEnemy === null) return;
        if (zone.id === 'killZone') state.killTargets = [draggedEnemy];
        else if (!state.ccTargets.includes(draggedEnemy)) state.ccTargets.push(draggedEnemy);
        draggedEnemy = null;
        renderEnemyPool(); renderAssignedTargets(); saveState();
      });
    });
  }

  document.getElementById('strategyTitle').addEventListener('input', function() { state.title = this.value; saveState(); });

  document.querySelectorAll('.bracket-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.bracket-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      state.bracket = this.dataset.bracket;
      updatePlayerSlots('your', parseInt(state.bracket[0]));
      updatePlayerSlots('enemy', parseInt(state.bracket[0]));
      refreshAllSteps(); saveState();
    });
  });

  document.querySelectorAll('.faction-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const team = this.dataset.team;
      const faction = this.dataset.faction;
      document.querySelectorAll('.faction-btn[data-team="' + team + '"]').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      if (team === 'your') state.yourTeam.faction = faction;
      else state.enemyTeam.faction = faction;
      const teamData = team === 'your' ? state.yourTeam : state.enemyTeam;
      teamData.players.forEach((p, i) => { p.race = null; renderPlayerSlot(team, i); });
      saveState();
    });
  });

  document.querySelectorAll('.map-option').forEach(opt => {
    opt.addEventListener('click', function() {
      document.querySelectorAll('.map-option').forEach(o => o.classList.remove('active'));
      this.classList.add('active');
      state.map = this.dataset.map;
      saveState();
    });
  });

  function updatePlayerSlots(team, count) {
    const container = document.getElementById(team === 'your' ? 'yourPlayers' : 'enemyPlayers');
    const teamData = team === 'your' ? state.yourTeam : state.enemyTeam;
    while (teamData.players.length < count) teamData.players.push({ class: null, spec: null, race: null });
    while (teamData.players.length > count) teamData.players.pop();
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const slot = document.createElement('div');
      slot.className = 'player-slot';
      slot.dataset.team = team;
      slot.dataset.index = i;
      container.appendChild(slot);
      renderPlayerSlot(team, i);
    }
    if (team === 'enemy') { renderEnemyPool(); renderAssignedTargets(); }
  }

  function renderPlayerSlot(team, index) {
    const slot = document.querySelector('.player-slot[data-team="' + team + '"][data-index="' + index + '"]');
    if (!slot) return;
    const teamData = team === 'your' ? state.yourTeam : state.enemyTeam;
    const player = teamData.players[index];
    
    if (player.class && player.spec && player.race) {
      slot.innerHTML = '<div class="selected-summary"><div class="summary-content"><div class="summary-icons"><img src="' + DATA.classes[player.class].icon + '" class="summary-icon"><img src="' + DATA.getSpecIcon(player.class, player.spec) + '" class="summary-icon">' + (player.race !== 'Any' && teamData.faction !== 'Both' ? '<img src="' + DATA.races[teamData.faction][player.race].icon + '" class="summary-icon">' : '') + '</div><div class="summary-text">' + player.spec + ' ' + player.class + (player.race !== 'Any' ? ' (' + player.race + ')' : '') + '</div></div><button class="change-btn">Change</button></div>';
      slot.querySelector('.change-btn').addEventListener('click', () => {
        player.class = null; player.spec = null; player.race = null;
        renderPlayerSlot(team, index);
        if (team === 'enemy') {
          state.killTargets = state.killTargets.filter(i => i !== index);
          state.ccTargets = state.ccTargets.filter(i => i !== index);
          renderEnemyPool(); renderAssignedTargets();
        }
        saveState();
      });
      return;
    }
    
    if (!player.class) {
      const div = document.createElement('div');
      div.className = 'selection-step';
      div.innerHTML = '<div class="step-label">Select Class</div><div class="selection-grid"></div>';
      slot.innerHTML = '';
      slot.appendChild(div);
      const grid = div.querySelector('.selection-grid');
      Object.keys(DATA.classes).forEach(className => {
        const opt = document.createElement('div');
        opt.className = 'selection-option';
        opt.innerHTML = '<img src="' + DATA.classes[className].icon + '" class="option-icon"><div class="option-text">' + className + '</div>';
        opt.addEventListener('click', () => {
          player.class = className; player.spec = null; player.race = null;
          renderPlayerSlot(team, index);
          if (team === 'enemy') { renderEnemyPool(); renderAssignedTargets(); }
          else if (team === 'your') refreshAllSteps();
          saveState();
        });
        grid.appendChild(opt);
      });
      return;
    }
    
    if (!player.spec) {
      const div = document.createElement('div');
      div.className = 'selection-step';
      div.innerHTML = '<div class="step-label">' + player.class + ' - Select Spec</div><div class="selection-grid"></div>';
      slot.innerHTML = '';
      slot.appendChild(div);
      const grid = div.querySelector('.selection-grid');
      DATA.classes[player.class].specs.forEach(specName => {
        const opt = document.createElement('div');
        opt.className = 'selection-option';
        opt.innerHTML = '<img src="' + DATA.getSpecIcon(player.class, specName) + '" class="option-icon"><div class="option-text">' + specName + '</div>';
        opt.addEventListener('click', () => { player.spec = specName; renderPlayerSlot(team, index); saveState(); });
        grid.appendChild(opt);
      });
      return;
    }
    
    if (!player.race) {
      const faction = teamData.faction;
      if (!faction || faction === 'Both') {
        slot.innerHTML = '<div class="step-label" style="color:var(--text-muted)">Faction: Both - Race not needed</div>';
        player.race = 'Any'; saveState(); return;
      }
      const availableRaces = DATA.getRacesForClass(faction, player.class);
      const div = document.createElement('div');
      div.className = 'selection-step';
      div.innerHTML = '<div class="step-label">' + player.spec + ' ' + player.class + ' - Select Race</div><div class="selection-grid"></div>';
      slot.innerHTML = '';
      slot.appendChild(div);
      const grid = div.querySelector('.selection-grid');
      availableRaces.forEach(race => {
        const opt = document.createElement('div');
        opt.className = 'selection-option';
        opt.innerHTML = '<img src="' + race.icon + '" class="option-icon race"><div class="option-text">' + race.name + '</div>';
        opt.addEventListener('click', () => { player.race = race.name; renderPlayerSlot(team, index); saveState(); });
        grid.appendChild(opt);
      });
    }
  }

  document.querySelectorAll('.section-header').forEach(header => {
    header.addEventListener('click', function() {
      const content = document.getElementById(this.dataset.section + 'Section');
      if (content.classList.contains('active')) { content.classList.remove('active'); this.classList.add('collapsed'); }
      else { content.classList.add('active'); this.classList.remove('collapsed'); }
    });
  });

  document.querySelectorAll('.add-step-btn').forEach(btn => {
    btn.addEventListener('click', function() { addStep(this.dataset.section); });
  });

  function addStep(section) {
    const step = { id: 'step_' + Date.now(), label: '', content: '', images: [], ccChains: [] };
    state.sections[section].push(step);
    renderStep(section, step);
    initSortable(section);
    saveState();
  }

  function renderStep(section, step) {
    const container = document.getElementById(section + 'Steps');
    if (!container) return;
    const stepIndex = state.sections[section].findIndex(s => s.id === step.id);
    const stepEl = document.createElement('div');
    stepEl.className = 'step-item';
    stepEl.dataset.stepId = step.id;
    stepEl.dataset.section = section;
    
    let editorsHTML = '';
    if (state.yourTeam.players && state.yourTeam.players.length > 0) {
      state.yourTeam.players.forEach((player, playerIdx) => {
        if (!player.class) return;
        const editorId = 'editor_' + step.id + '_player_' + playerIdx;
        editorsHTML += '<div class="player-step-section"><div class="player-step-header"><img src="' + DATA.classes[player.class].icon + '" class="player-step-icon"><div class="player-step-name">' + player.class + '</div></div><div class="step-editor" id="' + editorId + '"></div></div>';
      });
    } else {
      editorsHTML = '<div class="step-editor" id="editor_' + step.id + '"></div>';
    }
    
    stepEl.innerHTML = '<div class="step-header"><div class="step-number">' + (stepIndex + 1) + '</div><div class="step-title">STEP ' + (stepIndex + 1) + '</div><button class="step-edit-btn" data-step-id="' + step.id + '" style="display:none;">✏️ Edit</button><button class="step-save-btn" data-step-id="' + step.id + '" style="display:none;"><span class="save-icon">✓</span> Save</button><button class="step-control-btn delete">×</button></div><div class="step-content-wrapper" data-step-id="' + step.id + '">' + editorsHTML + '<div class="step-readonly-view" style="display:none;"></div></div><div class="cc-chains-container" id="ccChains_' + step.id + '"></div><div class="step-actions"><button class="add-cc-chain-btn" data-step-id="' + step.id + '">⚡ Add CC Chain</button><div class="image-upload-area" data-step-id="' + step.id + '"><div class="upload-icon">📷</div><div class="upload-text">Add images</div><input type="file" accept="image/*" multiple style="display:none" class="image-input"></div></div><div class="uploaded-images" id="images_' + step.id + '"></div>';
    container.appendChild(stepEl);
    
    stepEl.querySelector('.delete').addEventListener('click', function() {
      const section = this.closest('.step-item').dataset.section;
      deleteStep(section, step.id);
    });
    
    stepEl.querySelector('.step-save-btn')?.addEventListener('click', function() {
      const stepId = this.dataset.stepId;
      let readonlyHTML = '';
      const stepData = state.sections[section].find(s => s.id === stepId);
      if (stepData && stepData.playerContent && Object.keys(stepData.playerContent).length > 0) {
        Object.keys(stepData.playerContent).forEach(playerKey => {
          const playerIdx = parseInt(playerKey.split('_')[1]);
          const player = state.yourTeam.players[playerIdx];
          const content = stepData.playerContent[playerKey];
          if (content && content.trim()) {
            readonlyHTML += '<div class="readonly-player-content"><div class="readonly-player-header"><img src="' + DATA.classes[player.class].icon + '" class="readonly-player-icon"><div class="readonly-player-name">' + player.class + '</div></div><div class="readonly-player-text">' + content + '</div></div>';
          }
        });
      } else if (stepData && stepData.content) {
        readonlyHTML = '<div class="readonly-player-text">' + stepData.content + '</div>';
      }
      const wrapper = stepEl.querySelector('.step-content-wrapper');
      const readonlyView = wrapper.querySelector('.step-readonly-view');
      readonlyView.innerHTML = readonlyHTML;
      wrapper.querySelectorAll('.player-step-section').forEach(el => el.style.display = 'none');
      wrapper.querySelectorAll('.step-editor').forEach(el => el.style.display = 'none');
      readonlyView.style.display = 'block';
      stepEl.querySelector('.step-edit-btn').style.display = 'flex';
      this.style.display = 'none';
      stepEl.querySelector('.step-actions').style.display = 'none';
    });
    
    stepEl.querySelector('.step-edit-btn')?.addEventListener('click', function() {
      const wrapper = stepEl.querySelector('.step-content-wrapper');
      wrapper.querySelectorAll('.player-step-section').forEach(el => el.style.display = 'block');
      wrapper.querySelectorAll('.step-editor').forEach(el => el.style.display = 'block');
      wrapper.querySelector('.step-readonly-view').style.display = 'none';
      stepEl.querySelector('.step-save-btn').style.display = 'flex';
      this.style.display = 'none';
      stepEl.querySelector('.step-actions').style.display = 'flex';
    });
    
    stepEl.querySelector('.add-cc-chain-btn').addEventListener('click', function() { openCCModal(step.id); });
    const uploadArea = stepEl.querySelector('.image-upload-area');
    const fileInput = stepEl.querySelector('.image-input');
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', function() { handleImageUpload(section, step.id, this.files); this.value = ''; });
    
    setTimeout(() => {
      if (state.yourTeam.players && state.yourTeam.players.length > 0) {
        state.yourTeam.players.forEach((player, playerIdx) => {
          if (!player.class) return;
          initEditor(section, step.id, 'player_' + playerIdx);
        });
      } else {
        initEditor(section, step.id, null);
      }
    }, 100);
    
    renderImages(section, step.id);
    renderCCChains(section, step.id);
  }

  function refreshAllSteps() {
    state.editors = {};
    Object.keys(state.sections).forEach(section => {
      const container = document.getElementById(section + 'Steps');
      if (container) {
        container.innerHTML = '';
        state.sections[section].forEach(step => renderStep(section, step));
      }
    });
  }

  function initEditor(section, stepId, playerKey) {
    const editorId = playerKey ? 'editor_' + stepId + '_' + playerKey : 'editor_' + stepId;
    const container = document.getElementById(editorId);
    if (!container || state.editors[editorId]) return;
    
    let placeholder = '✨ Click here to start typing your strategy...';
    if (playerKey) {
      const playerIdx = parseInt(playerKey.split('_')[1]);
      const player = state.yourTeam.players[playerIdx];
      if (player && player.class) {
        const placeholders = {
          'Rogue': '🗡️ Opening move: Sap? Cheap Shot? Positioning behind pillar?',
          'Warlock': '🔥 Position for Fear/Coil. Maintain distance from melee. Pre-dot?',
          'Priest': '✨ Pre-shield teammates. Positioning for dispels. Fear target?',
          'Mage': '❄️ Polymorph priority? Positioning for ring/nova? Opener CS?',
          'Warrior': '⚔️ Charge target? Hamstring peels? Stance management?',
          'Druid': '🌿 Cyclone target? Root positioning? Form to start in?',
          'Paladin': '🛡️ Bubble timing? Hammer of Justice target? Blessing priority?',
          'Shaman': '⚡ Grounding placement? Shock target? Totem priority?',
          'Hunter': '🏹 Trap target? Pet positioning? Mark strategy?'
        };
        placeholder = placeholders[player.class] || placeholder;
      }
    }
    
    try {
      const quill = new Quill(container, {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link']] },
        placeholder: placeholder
      });
      const step = state.sections[section].find(s => s.id === stepId);
      if (step) {
        if (!step.playerContent) step.playerContent = {};
        if (playerKey && step.playerContent[playerKey]) quill.root.innerHTML = step.playerContent[playerKey];
        else if (!playerKey && step.content) quill.root.innerHTML = step.content;
      }
      quill.on('text-change', () => {
        const stepData = state.sections[section].find(s => s.id === stepId);
        if (stepData) {
          if (!stepData.playerContent) stepData.playerContent = {};
          if (playerKey) stepData.playerContent[playerKey] = quill.root.innerHTML;
          else stepData.content = quill.root.innerHTML;
          const saveBtn = document.querySelector('.step-save-btn[data-step-id="' + stepId + '"]');
          if (saveBtn && !saveBtn.classList.contains('saved')) {
            saveBtn.style.display = 'flex';
            saveBtn.classList.remove('saved');
            saveBtn.innerHTML = '<span class="save-icon">✓</span> Save';
          }
          saveState();
        }
      });
      quill.root.addEventListener('focus', () => { container.classList.add('ql-focused'); });
      quill.root.addEventListener('blur', () => { container.classList.remove('ql-focused'); });
      state.editors[editorId] = quill;
    } catch (e) {}
  }

  async function handleImageUpload(section, stepId, files) {
    const stepData = state.sections[section].find(s => s.id === stepId);
    if (!stepData) return;
    for (const file of Array.from(files)) {
      if (!file.type.startsWith('image/')) continue;
      try {
        const compressed = await compressImage(file);
        stepData.images.push(compressed);
        renderImages(section, stepId);
      } catch (e) {}
    }
    saveState();
  }

  function compressImage(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > 1200 || h > 1200) {
            if (w > h) { h = (h/w) * 1200; w = 1200; }
            else { w = (w/h) * 1200; h = 1200; }
          }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function renderImages(section, stepId) {
    const container = document.getElementById('images_' + stepId);
    if (!container) return;
    const stepData = state.sections[section].find(s => s.id === stepId);
    if (!stepData) return;
    container.innerHTML = '';
    stepData.images.forEach((img, idx) => {
      const imgEl = document.createElement('div');
      imgEl.className = 'uploaded-image';
      imgEl.innerHTML = '<img src="' + img + '"><button class="remove-image-btn">×</button>';
      imgEl.querySelector('.remove-image-btn').addEventListener('click', () => {
        stepData.images.splice(idx, 1);
        renderImages(section, stepId);
        saveState();
      });
      container.appendChild(imgEl);
    });
  }

  let undoState = null, undoTimer = null;

  function deleteStep(section, stepId) {
    const index = state.sections[section].findIndex(s => s.id === stepId);
    if (index === -1) return;
    undoState = { section: section, stepId: stepId, index: index, step: JSON.parse(JSON.stringify(state.sections[section][index])) };
    state.sections[section].splice(index, 1);
    document.querySelector('.step-item[data-step-id="' + stepId + '"]')?.remove();
    Object.keys(state.editors).forEach(key => { if (key.includes(stepId)) delete state.editors[key]; });
    renumberSteps(section);
    saveState();
    const toast = document.getElementById('undoToast');
    const toastText = document.getElementById('undoToastText');
    toastText.textContent = 'Step deleted';
    toast.classList.add('active');
    if (undoTimer) clearTimeout(undoTimer);
    undoTimer = setTimeout(() => { toast.classList.remove('active'); undoState = null; }, 5000);
  }

  function undoDelete() {
    if (!undoState) return;
    const { section, stepId, index, step } = undoState;
    state.sections[section].splice(index, 0, step);
    const container = document.getElementById(section + 'Steps');
    if (container) { container.innerHTML = ''; state.sections[section].forEach(s => renderStep(section, s)); }
    initSortable(section);
    saveState();
    const toast = document.getElementById('undoToast');
    toast.classList.remove('active');
    if (undoTimer) clearTimeout(undoTimer);
    undoState = null;
  }

  function renumberSteps(section) {
    const container = document.getElementById(section + 'Steps');
    container?.querySelectorAll('.step-number').forEach((num, idx) => num.textContent = idx + 1);
  }

  function initSortable(section) {
    const container = document.getElementById(section + 'Steps');
    if (!container) return;
    if (state.sortables[section]) state.sortables[section].destroy();
    state.sortables[section] = new Sortable(container, {
      animation: 150,
      handle: '.step-item',
      onEnd: (evt) => {
        const item = state.sections[section].splice(evt.oldIndex, 1)[0];
        state.sections[section].splice(evt.newIndex, 0, item);
        renumberSteps(section);
        saveState();
      }
    });
  }

  function validateStrategy() {
    const errors = [];
    if (!state.bracket) errors.push('Select bracket');
    if (!state.yourTeam.faction) errors.push('Select your faction');
    if (!state.enemyTeam.faction) errors.push('Select enemy faction');
    if (state.yourTeam.players.filter(p => p.class).length === 0) errors.push('Add your comp');
    if (state.enemyTeam.players.filter(p => p.class).length === 0) errors.push('Add enemy comp');
    const hasContent = Object.keys(state.sections).some(s => state.sections[s].length > 0);
    if (!hasContent) errors.push('Add strategy steps');
    return errors;
  }

  function generateTitle() {
    if (state.title) return state.title;
    const your = state.yourTeam.players.filter(p => p.class).map(p => p.class).join('/');
    const enemy = state.enemyTeam.players.filter(p => p.class).map(p => p.class).join('/');
    return your && enemy ? your + ' vs ' + enemy + ' - ' + state.bracket : 'TBC Arena Strategy';
  }

  function generatePublishedHTML() {
    const title = state.title || generateTitle();
    const author = document.getElementById('authorName')?.value.trim() || 'Anonymous';
    const bracket = state.bracket || '3v3';
    const map = state.map || 'Any Map';
    const yourComp = state.yourTeam.players.filter(p => p.class).map(p => '<span class="comp-player"><img src="' + DATA.classes[p.class].icon + '" class="comp-icon">' + p.spec + ' ' + p.class + '</span>').join('');
    const enemyComp = state.enemyTeam.players.filter(p => p.class).map(p => '<span class="comp-player"><img src="' + DATA.classes[p.class].icon + '" class="comp-icon">' + p.spec + ' ' + p.class + '</span>').join('');
    
    let killTargetHTML = '', ccTargetsHTML = '';
    if (state.killTargets.length > 0) { 
      const kt = state.enemyTeam.players[state.killTargets[0]]; 
      killTargetHTML = '<div class="target-badge kill"><span class="target-label">🔴 KILL</span><img src="' + DATA.classes[kt.class].icon + '" class="target-icon">' + kt.class + '</div>'; 
    }
    if (state.ccTargets.length > 0) { 
      ccTargetsHTML = state.ccTargets.map(idx => { 
        const ct = state.enemyTeam.players[idx]; 
        return '<div class="target-badge cc"><span class="target-label">⚫ CC</span><img src="' + DATA.classes[ct.class].icon + '" class="target-icon">' + ct.class + '</div>'; 
      }).join(''); 
    }
    
    let html = '';
    
    // Hero header
    html += '<div class="pub-hero">';
    html += '<div class="pub-title">' + title + '</div>';
    html += '<div class="pub-meta">';
    html += '<span class="pub-meta-item">✍️ ' + author + '</span>';
    html += '<span class="pub-meta-item">📅 ' + new Date().toLocaleDateString() + '</span>';
    html += '<span class="pub-meta-item">🎮 ' + bracket + '</span>';
    if (map && map !== 'Any Map') html += '<span class="pub-meta-item">📍 ' + map + '</span>';
    html += '</div></div>';
    
    // Matchup card
    html += '<div class="pub-matchup">';
    html += '<div class="pub-matchup-inner">';
    html += '<div class="pub-team your"><div class="pub-team-label">YOUR TEAM</div><div class="pub-team-comp">' + yourComp + '</div></div>';
    html += '<div class="pub-vs">VS</div>';
    html += '<div class="pub-team enemy"><div class="pub-team-label">ENEMY TEAM</div><div class="pub-team-comp">' + enemyComp + '</div></div>';
    html += '</div>';
    if (killTargetHTML || ccTargetsHTML) {
      html += '<div class="pub-targets">' + killTargetHTML + ccTargetsHTML + '</div>';
    }
    html += '</div>';
    
    // Strategy sections
    const sectionData = { 
      opener: { title: 'The Opener', icon: '🎯', desc: 'How to start the match' }, 
      midgame: { title: 'Mid Game', icon: '⚡', desc: 'Pressure and control phase' }, 
      wincondition: { title: 'Win Condition', icon: '🏆', desc: 'How to secure the kill' }, 
      matchupnotes: { title: 'Matchup Notes', icon: '💡', desc: 'Key things to remember' }, 
      map: { title: 'Map Strategy', icon: '📍', desc: 'Positioning and map usage' } 
    };
    
    Object.keys(sectionData).forEach(key => {
      const steps = state.sections[key];
      if (!steps || steps.length === 0) return;
      const hasContent = steps.some(step => {
        if (step.playerContent && Object.keys(step.playerContent).some(k => step.playerContent[k]?.trim())) return true;
        if (step.content?.trim()) return true;
        if (step.ccChains?.length > 0) return true;
        return false;
      });
      if (!hasContent) return;
      
      const section = sectionData[key];
      html += '<div class="pub-section">';
      html += '<div class="pub-section-header"><span class="pub-section-icon">' + section.icon + '</span><div class="pub-section-titles"><div class="pub-section-title">' + section.title + '</div><div class="pub-section-desc">' + section.desc + '</div></div></div>';
      html += '<div class="pub-section-content">';
      
      steps.forEach((step, idx) => {
        let hasStepContent = false;
        let stepHTML = '<div class="pub-step"><div class="pub-step-num">' + (idx + 1) + '</div><div class="pub-step-body">';
        
        if (step.playerContent && Object.keys(step.playerContent).length > 0) {
          Object.keys(step.playerContent).forEach(playerKey => {
            const playerIdx = parseInt(playerKey.split('_')[1]);
            const player = state.yourTeam.players[playerIdx];
            const content = step.playerContent[playerKey];
            if (content && content.trim() && content !== '<p><br></p>') {
              hasStepContent = true;
              stepHTML += '<div class="pub-player-action"><div class="pub-player-header"><img src="' + DATA.classes[player.class].icon + '" class="pub-player-icon"><span class="pub-player-name">' + player.class + '</span></div><div class="pub-player-text">' + content + '</div></div>';
            }
          });
        } else if (step.content && step.content.trim() && step.content !== '<p><br></p>') {
          hasStepContent = true;
          stepHTML += '<div class="pub-player-text">' + step.content + '</div>';
        }
        
        // Include CC chains
        if (step.ccChains && step.ccChains.length > 0) {
          hasStepContent = true;
          step.ccChains.forEach(chain => {
            stepHTML += generateVisualCCTimeline(chain.abilities);
          });
        }
        
        stepHTML += '</div></div>';
        if (hasStepContent) html += stepHTML;
      });
      
      html += '</div></div>';
    });
    
    return html;
  }

  window.handlePublish = function() {
    const errors = validateStrategy();
    if (errors.length > 0) { alert('Please complete your strategy first:\n\n' + errors.join('\n')); return; }
    document.getElementById('publishOverlay').classList.add('active');
    document.getElementById('publishModal').classList.add('active');
  };

  window.handleReset = function() {
    if (confirm('⚠️ NUCLEAR RESET: This will delete EVERYTHING and reload the page. Continue?')) {
      try { localStorage.clear(); } catch(e) {}
      try { sessionStorage.clear(); } catch(e) {}
      const cleanURL = window.location.href.split('#')[0].split('?')[0];
      window.location.replace(cleanURL);
      setTimeout(() => { window.location.href = cleanURL; window.location.reload(true); }, 100);
    }
  };

  function loadFromURL() {
    const hash = window.location.hash;
    if (!hash.includes('strategy=')) return false;
    try {
      const decoded = JSON.parse(atob(hash.split('strategy=')[1]));
      state.title = decoded.title; state.bracket = decoded.bracket;
      state.yourTeam = decoded.yourTeam; state.enemyTeam = decoded.enemyTeam;
      state.killTargets = decoded.killTargets || []; state.ccTargets = decoded.ccTargets || [];
      state.map = decoded.map; state.sections = decoded.sections;
      
      // Auto-show published view for shared links
      setTimeout(() => {
        const publishedHTML = generatePublishedHTML();
        document.getElementById('publishedContent').innerHTML = publishedHTML;
        document.getElementById('publishedViewOverlay').classList.add('active');
        document.getElementById('publishedView').classList.add('active');
      }, 100);
      
      return true;
    } catch (e) { return false; }
  }

  function restoreUI() {
    if (state.title) document.getElementById('strategyTitle').value = state.title;
    if (state.bracket) {
      const btn = document.querySelector('.bracket-btn[data-bracket="' + state.bracket + '"]');
      if (btn) { btn.classList.add('active'); updatePlayerSlots('your', parseInt(state.bracket[0])); updatePlayerSlots('enemy', parseInt(state.bracket[0])); }
    }
    if (state.yourTeam.faction) document.querySelector('.faction-btn[data-team="your"][data-faction="' + state.yourTeam.faction + '"]')?.classList.add('active');
    if (state.enemyTeam.faction) document.querySelector('.faction-btn[data-team="enemy"][data-faction="' + state.enemyTeam.faction + '"]')?.classList.add('active');
    if (state.map) document.querySelector('.map-option[data-map="' + state.map + '"]')?.classList.add('active');
    ['your', 'enemy'].forEach(team => {
      const teamData = team === 'your' ? state.yourTeam : state.enemyTeam;
      teamData.players.forEach((player, idx) => { renderPlayerSlot(team, idx); });
    });
    renderEnemyPool(); renderAssignedTargets();
    Object.keys(state.sections).forEach(section => {
      state.sections[section].forEach(step => renderStep(section, step));
      if (state.sections[section].length > 0) setTimeout(() => initSortable(section), 200);
    });
  }

  window.addEventListener('DOMContentLoaded', function() {
    const fromURL = loadFromURL();
    if (!fromURL) loadState();
    setupDropZones();
    restoreUI();
    
    const hasSeenWelcome = localStorage.getItem('tbc_strategy_builder_welcome');
    if (!hasSeenWelcome) {
      setTimeout(() => {
        document.getElementById('welcomeTooltip')?.classList.add('active');
        document.getElementById('welcomeOverlay')?.classList.add('active');
      }, 800);
    }
    
    const closeWelcomeModal = () => {
      document.getElementById('welcomeTooltip')?.classList.remove('active');
      document.getElementById('welcomeOverlay')?.classList.remove('active');
      localStorage.setItem('tbc_strategy_builder_welcome', 'true');
    };
    
    const closePublishModal = () => {
      document.getElementById('publishOverlay')?.classList.remove('active');
      document.getElementById('publishModal')?.classList.remove('active');
    };
    
    document.getElementById('closeWelcome')?.addEventListener('click', closeWelcomeModal);
    document.getElementById('welcomeOverlay')?.addEventListener('click', closeWelcomeModal);
    document.getElementById('undoBtn')?.addEventListener('click', undoDelete);
    
    if (hasSeenWelcome && (!state.sections.opener || state.sections.opener.length === 0)) addStep('opener');
    
    updateProgress(); updateSectionCompletionStates();
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('publishedView')?.classList.contains('active')) {
          e.preventDefault();
          document.getElementById('publishedViewOverlay').classList.remove('active');
          document.getElementById('publishedView').classList.remove('active');
          return;
        }
        if (document.getElementById('publishModal')?.classList.contains('active')) { e.preventDefault(); closePublishModal(); return; }
        if (document.getElementById('welcomeTooltip')?.classList.contains('active')) { e.preventDefault(); closeWelcomeModal(); return; }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const activeStep = document.activeElement.closest('.step-item');
        if (activeStep) { const stepId = activeStep.dataset.stepId; if (stepId) openCCModal(stepId); }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const activeSection = document.activeElement.closest('.strategy-section');
        if (activeSection) { e.preventDefault(); const sectionName = activeSection.querySelector('.section-header').dataset.section; if (sectionName) addStep(sectionName); }
      }
    });
    
    document.getElementById('publishBtn')?.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); window.handlePublish(); }, true);
    document.getElementById('closePublishModal')?.addEventListener('click', closePublishModal);
    document.getElementById('publishOverlay')?.addEventListener('click', closePublishModal);
    
    document.getElementById('publishDownloadPDF')?.addEventListener('click', async function() {
      const errors = validateStrategy();
      if (errors.length > 0) { alert('Please complete your strategy first:\n\n' + errors.join('\n')); return; }
      this.disabled = true; this.innerHTML = '⏳ Generating PDF...';
      try {
        if (typeof window.jspdf === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          document.head.appendChild(script);
          await new Promise((resolve, reject) => { script.onload = resolve; script.onerror = reject; });
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        const lineHeight = 7;
        doc.setFontSize(20); doc.setFont(undefined, 'bold');
        const title = generateTitle();
        doc.text(title, margin, y); y += 15;
        doc.setFontSize(10); doc.setFont(undefined, 'normal');
        const author = document.getElementById('authorName').value.trim() || 'Anonymous';
        doc.text('By ' + author + ' | ' + new Date().toLocaleDateString(), margin, y); y += 10;
        doc.setFontSize(12); doc.setFont(undefined, 'bold');
        doc.text('Your Team:', margin, y); y += lineHeight;
        doc.setFont(undefined, 'normal');
        const yourText = state.yourTeam.players.filter(p => p.class).map(p => p.spec + ' ' + p.class).join(', ');
        doc.text(yourText, margin + 5, y); y += lineHeight + 3;
        doc.setFont(undefined, 'bold');
        doc.text('Enemy Team:', margin, y); y += lineHeight;
        doc.setFont(undefined, 'normal');
        const enemyText = state.enemyTeam.players.filter(p => p.class).map(p => p.spec + ' ' + p.class).join(', ');
        doc.text(enemyText, margin + 5, y); y += lineHeight + 3;
        if (state.killTargets.length > 0 || state.ccTargets.length > 0) {
          let targetText = 'Targets: ';
          if (state.killTargets.length > 0) { const killTarget = state.enemyTeam.players[state.killTargets[0]]; targetText += 'Kill: ' + killTarget.class; }
          if (state.ccTargets.length > 0) { const ccTargets = state.ccTargets.map(idx => state.enemyTeam.players[idx].class).join(', '); targetText += (state.killTargets.length > 0 ? ' | ' : '') + 'CC: ' + ccTargets; }
          doc.text(targetText, margin + 5, y); y += lineHeight + 5;
        }
        if (state.map) { doc.setFont(undefined, 'bold'); doc.text('Map: ' + state.map, margin, y); y += lineHeight + 5; }
        const sectionTitles = { opener: 'OPENER', midgame: 'MID GAME', wincondition: 'WIN CONDITION', matchupnotes: 'MATCHUP NOTES', map: 'MAP CONSIDERATIONS' };
        Object.keys(sectionTitles).forEach(key => {
          const steps = state.sections[key];
          if (steps.length === 0) return;
          if (y > pageHeight - 40) { doc.addPage(); y = 20; }
          doc.setFontSize(14); doc.setFont(undefined, 'bold');
          doc.text(sectionTitles[key], margin, y); y += lineHeight + 3;
          steps.forEach((step, idx) => {
            if (y > pageHeight - 30) { doc.addPage(); y = 20; }
            doc.setFontSize(11); doc.setFont(undefined, 'bold');
            doc.text('Step ' + (idx + 1), margin, y); y += lineHeight;
            doc.setFontSize(10); doc.setFont(undefined, 'normal');
            if (step.playerContent && Object.keys(step.playerContent).length > 0) {
              Object.keys(step.playerContent).forEach(playerKey => {
                const playerIdx = parseInt(playerKey.split('_')[1]);
                const player = state.yourTeam.players[playerIdx];
                const content = step.playerContent[playerKey];
                if (content && content.trim()) {
                  const div = document.createElement('div'); div.innerHTML = content;
                  const text = (div.textContent || div.innerText || '').trim();
                  if (text) { doc.text(player.class + ': ' + text, margin + 5, y); y += lineHeight; }
                }
              });
            } else if (step.content) {
              const div = document.createElement('div'); div.innerHTML = step.content;
              const text = (div.textContent || div.innerText || '').trim();
              if (text) { const lines = doc.splitTextToSize(text, 170); doc.text(lines, margin + 5, y); y += lines.length * lineHeight; }
            }
            y += 3;
          });
          y += 5;
        });
        const filename = title.replace(/[^a-z0-9]/gi, '_') + '.pdf';
        doc.save(filename);
        closePublishModal();
        const toast = document.getElementById('undoToast');
        const toastText = document.getElementById('undoToastText');
        toastText.textContent = '✓ PDF Downloaded!';
        toast.classList.add('active');
        setTimeout(() => toast.classList.remove('active'), 3000);
        this.disabled = false;
      } catch (e) {
        console.error('PDF Error:', e);
        alert('PDF export failed: ' + e.message);
        this.disabled = false;
      }
    });
    
    document.getElementById('publishGenerateLink')?.addEventListener('click', function() {
      try {
        const encoded = btoa(JSON.stringify({ title: state.title, bracket: state.bracket, yourTeam: state.yourTeam, enemyTeam: state.enemyTeam, killTargets: state.killTargets, ccTargets: state.ccTargets, map: state.map, sections: state.sections }));
        const url = window.location.origin + window.location.pathname + '#strategy=' + encoded;
        navigator.clipboard.writeText(url).then(() => {
          closePublishModal();
          const toast = document.getElementById('undoToast');
          const toastText = document.getElementById('undoToastText');
          toastText.textContent = '✓ Link Copied to Clipboard!';
          toast.classList.add('active');
          setTimeout(() => toast.classList.remove('active'), 3000);
        }).catch(() => { prompt('Copy this link:', url); });
      } catch (e) { alert('Failed to generate link: ' + e.message); }
    });
    
    document.getElementById('publishViewGuide')?.addEventListener('click', function() {
      closePublishModal();
      const publishedHTML = generatePublishedHTML();
      document.getElementById('publishedContent').innerHTML = publishedHTML;
      document.getElementById('publishedViewOverlay').classList.add('active');
      document.getElementById('publishedView').classList.add('active');
    });
    
    document.getElementById('closePublishedView')?.addEventListener('click', function() {
      document.getElementById('publishedViewOverlay').classList.remove('active');
      document.getElementById('publishedView').classList.remove('active');
    });
    
    document.getElementById('publishedViewOverlay')?.addEventListener('click', function() {
      document.getElementById('publishedViewOverlay').classList.remove('active');
      document.getElementById('publishedView').classList.remove('active');
    });
    
    document.getElementById('downloadFromPublished')?.addEventListener('click', function() {
      document.getElementById('publishDownloadPDF')?.click();
    });
    
    document.getElementById('shareFromPublished')?.addEventListener('click', function() {
      document.getElementById('publishGenerateLink')?.click();
    });
    
    document.getElementById('resetBtn')?.addEventListener('click', function(e) {
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      window.handleReset();
    }, true);
  });
})();
</script>

{% schema %}
{
  "name": "Strategy Builder v1.8",
  "settings": [],
  "presets": [{ "name": "TBC Arena Strategy Builder" }]
}
{% endschema %}
